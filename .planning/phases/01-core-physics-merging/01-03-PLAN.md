---
phase: 01-core-physics-merging
plan: 03
type: execute
wave: 3
depends_on: ["01-01", "01-02"]
files_modified:
  - scripts/components/overflow_detector.gd
  - scenes/game/game.tscn
  - scenes/game/game.gd
  - scenes/ui/hud.tscn
  - scenes/ui/hud.gd
  - scenes/bucket/bucket.gd
autonomous: false

must_haves:
  truths:
    - "Game ends when a fruit stays above the overflow line for 2+ continuous seconds"
    - "No false game-overs during bounces, drops, or chain reactions"
    - "Next fruit to drop is previewed in the UI near the drop zone"
    - "Score is displayed in the HUD (value managed by GameManager, scoring logic in Phase 2)"
    - "Bucket rim glows red as fruits approach the overflow danger zone"
    - "Fruits stack naturally without jitter with 20+ fruits on screen"
  artifacts:
    - path: "scripts/components/overflow_detector.gd"
      provides: "Dwell timer game-over detection"
      contains: "OVERFLOW_DURATION"
    - path: "scenes/ui/hud.tscn"
      provides: "HUD with score and next-fruit preview"
    - path: "scenes/ui/hud.gd"
      provides: "HUD update logic"
      contains: "update_next_fruit"
  key_links:
    - from: "scripts/components/overflow_detector.gd"
      to: "scripts/autoloads/event_bus.gd"
      via: "emits game_over_triggered when dwell timer expires"
      pattern: "EventBus.game_over_triggered.emit"
    - from: "scripts/components/overflow_detector.gd"
      to: "scenes/bucket/bucket.gd"
      via: "calls set_warning_level for rim glow"
      pattern: "set_warning_level"
    - from: "scenes/ui/hud.gd"
      to: "scripts/autoloads/event_bus.gd"
      via: "listens for fruit_dropped to update next preview"
      pattern: "EventBus.*connect"
    - from: "scenes/game/game.gd"
      to: "scripts/components/overflow_detector.gd"
      via: "game scene contains overflow detector"
---

<objective>
Complete the Phase 1 game loop: add overflow detection with a 2-second dwell timer that prevents false positives, build the HUD with score display and next-fruit preview, wire the bucket rim glow to warn of overflow danger, and verify the complete experience through playtesting.

Purpose: Without overflow detection the game never ends. Without the HUD the player has no information. This plan completes Phase 1 into a fully playable game loop.
Output: A complete Phase 1 game: drop fruits, merge them, see next-fruit preview, game ends correctly on overflow.
</objective>

<execution_context>
@C:/Users/zycro/.claude/get-shit-done/workflows/execute-plan.md
@C:/Users/zycro/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/01-core-physics-merging/01-RESEARCH.md
@.planning/phases/01-core-physics-merging/01-01-SUMMARY.md
@.planning/phases/01-core-physics-merging/01-02-SUMMARY.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create overflow detector with dwell timer and HUD with next-fruit preview</name>
  <files>
    scripts/components/overflow_detector.gd
    scenes/ui/hud.tscn
    scenes/ui/hud.gd
    scenes/game/game.tscn
    scenes/game/game.gd
    scenes/bucket/bucket.gd
  </files>
  <action>
    **overflow_detector.gd:**
    Create script with class_name OverflowDetector, extends Area2D:

    Constants:
    - `const OVERFLOW_DURATION: float = 2.0` -- seconds of continuous dwell before game over

    Properties:
    - `var _fruits_in_zone: Dictionary = {}` -- instance_id -> accumulated_time (float)
    - `var _bucket: Node = null` -- reference to bucket for warning level

    `func _ready() -> void`:
    - Connect body_entered and body_exited signals to handlers
    - Find bucket via group "bucket"
    - Set collision layer = 0 (doesn't need to be detected), collision mask = 1 (Fruits only)
    - Configure the Area2D's CollisionShape2D: a RectangleShape2D spanning the full bucket opening width at the overflow_y level. Height ~20px (thin detection strip).

    `func _on_body_entered(body: Node) -> void`:
    - Guard: if not (body is Fruit) -> return
    - Guard: if body.is_dropping or body.merge_grace or body.merging -> return
    - Add body.get_instance_id() to _fruits_in_zone with value 0.0

    `func _on_body_exited(body: Node) -> void`:
    - if body is Fruit: erase body.get_instance_id() from _fruits_in_zone

    `func _physics_process(delta: float) -> void`:
    - If GameManager.current_state == GameState.GAME_OVER: return (stop processing)
    - Track max_dwell = 0.0 for warning level calculation
    - Build a to_remove array for invalid entries
    - For each id in _fruits_in_zone:
      - if not is_instance_valid(instance_from_id(id)): add to to_remove, continue
      - Get fruit = instance_from_id(id) as Fruit
      - if fruit == null or fruit.is_dropping or fruit.merge_grace or fruit.merging: add to to_remove, continue
      - Accumulate: _fruits_in_zone[id] += delta
      - Track max_dwell = max(max_dwell, _fruits_in_zone[id])
      - If _fruits_in_zone[id] >= OVERFLOW_DURATION:
        - EventBus.game_over_triggered.emit()
        - set_physics_process(false) -- stop checking
        - return
    - Remove invalid entries
    - Update bucket warning: _bucket.set_warning_level(clampf(max_dwell / OVERFLOW_DURATION, 0.0, 1.0))
      This makes the bucket rim progressively glow from normal to red as a fruit approaches the 2s threshold.

    **Update bucket.gd** (from Plan 01):
    Add/update set_warning_level(level: float):
    - Modulate the RimHighlight Line2D color: lerp from default wood color to Color.RED based on level
    - When level > 0.8: also slightly increase the rim line width for extra urgency

    **hud.tscn:**
    Create a CanvasLayer scene (renders on top of game world):
    ```
    HUD (CanvasLayer)
      +-- ScoreLabel (Label) -- top center of screen, large font
      +-- NextFruitPreview (Control) -- positioned near the drop zone (top area, slightly offset)
        +-- NextFruitSprite (TextureRect or Sprite2D) -- shows the next fruit's texture/color
        +-- NextLabel (Label) -- "NEXT" text above the sprite
    ```

    Position ScoreLabel at top center (x=540, y=30), centered horizontally, large bold font (size 48+).
    Position NextFruitPreview at top-right of the drop zone area (approximately x=800, y=100) so it's visible but doesn't obstruct the play area. The "NEXT" label sits above the fruit sprite.

    **hud.gd:**
    Create script attached to HUD CanvasLayer:

    `var _fruit_types: Array[FruitData] = []` -- loaded in _ready for sprite lookup

    `func _ready() -> void`:
    - Load all 8 FruitData resources into _fruit_types
    - Connect EventBus.fruit_merged to _on_fruit_merged (update score display)
    - Connect EventBus.game_state_changed to _on_game_state_changed

    `func update_score(score: int) -> void`:
    - $ScoreLabel.text = str(score) (or formatted with comma separators)

    `func update_next_fruit(tier: int) -> void`:
    - Set NextFruitSprite texture and modulate color from _fruit_types[tier]
    - Scale the preview sprite to a consistent display size (e.g., 50x50px regardless of tier)

    `func _on_fruit_merged(old_tier: int, new_tier: int, pos: Vector2) -> void`:
    - update_score(GameManager.score) -- Phase 2 will populate score values; for now just display 0

    **Update game.tscn:**
    Add these nodes to the existing game scene:
    ```
    Game (Node2D)
      +-- ... (existing: Background, Bucket, FruitContainer, MergeManager, DropController)
      +-- OverflowDetector (Area2D, script: overflow_detector.gd) -- add to group "overflow_detector"
        +-- CollisionShape2D (RectangleShape2D) -- spans bucket opening at overflow_y
      +-- HUD (instance of hud.tscn)
    ```

    Position the OverflowDetector's Area2D at the overflow line Y position from the bucket. The CollisionShape2D should be a RectangleShape2D wide enough to cover the bucket opening and about 20px tall. Set its collision layer to 3 (Overflow), mask to 1 (Fruits). Actually -- Area2D uses monitoring, not collision layers for detection. Set monitoring=true, monitorable=false. The Area2D collision mask should be layer 1 (Fruits) so it detects fruit bodies entering.

    **Update game.gd:**
    - Get reference to HUD in _ready
    - Connect DropController's next_tier_changed (or equivalent signal) to HUD.update_next_fruit()
    - When DropController rolls a new next tier, the HUD updates the preview
    - On game over: show "GAME OVER" text via HUD (add a GameOverLabel to hud.tscn that's hidden by default, shown on game_over_triggered)

    **Wire the DropController to HUD:**
    The DropController needs to communicate the next fruit tier to the HUD. Options:
    - Add `signal next_tier_rolled(tier: int)` to DropController, emit in _roll_next_tier(), connect in game.gd to HUD.update_next_fruit()
    - OR use EventBus (add a signal `next_fruit_changed(tier: int)`)
    Use EventBus for decoupling: add `signal next_fruit_changed(tier: int)` to event_bus.gd, emit from DropController._roll_next_tier(), listen in hud.gd._ready().

    NOTE: Also add a simple "GAME OVER" label to the HUD that appears when EventBus.game_over_triggered fires. Just a centered Label with "GAME OVER" in large red text, visible only in GAME_OVER state.
  </action>
  <verify>
    1. Run the game -- HUD shows score (0) at top and next fruit preview near drop zone
    2. After dropping a fruit, the next-fruit preview updates to show the upcoming fruit
    3. Fill the bucket with many fruits until some stack above the overflow line
    4. Observe the bucket rim gradually glowing red as a fruit lingers near the overflow line
    5. After 2 continuous seconds above the line, "GAME OVER" appears
    6. Verify NO false game-over: drop a fruit that bounces above the line briefly then settles below -- game continues
    7. Verify NO false game-over during merges near the top of the bucket
    8. Check Godot Output panel for any errors during gameplay
  </verify>
  <done>
    OverflowDetector uses Area2D dwell timer (2s continuous) to trigger game over, ignoring dropping/merging/grace-period fruits. Bucket rim progressively glows red as warning. HUD shows score and next-fruit preview. Game over displays clearly on screen.
  </done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <name>Task 2: Playtest complete Phase 1 game loop</name>
  <files>none (verification only)</files>
  <action>
    Human playtests the complete Phase 1 game loop. Run the project in Godot (F5) and verify all core mechanics work correctly.

    **What was built:**
    Complete Phase 1 game loop: drop fruits into a trapezoid bucket, fruits stack with physics, same-tier fruits auto-merge into the next tier, next-fruit preview shows in HUD, overflow detection with 2-second dwell timer and rim glow warning, game over on sustained overflow.

    **Playtest checklist:**
    1. **Drop mechanics**: Move mouse above the bucket. A fruit follows your cursor with a faint vertical guide line. Click to drop. The fruit falls naturally under gravity.
    2. **Drop cooldown**: After dropping, there's a brief delay (~0.15s) before the next fruit appears. Rapid clicking should not spawn multiple fruits.
    3. **Next-fruit preview**: Check the HUD area near the drop zone -- it should show which fruit comes next. After each drop, it updates.
    4. **Physics stacking**: Drop 15-20 fruits. They should stack naturally inside the bucket without visible jitter or vibrating.
    5. **Merging**: Drop two fruits of the same tier near each other. When they touch, they should merge into one larger fruit at their midpoint. Only ONE new fruit appears (no duplicates).
    6. **Merge chain**: Drop fruits so that a merge creates a fruit that immediately touches another same-tier fruit, causing a second merge. Both should work correctly.
    7. **Tier restriction**: Only 5 smallest fruit types appear as drops (blueberry, grape, cherry, strawberry, orange). Larger fruits only appear from merging.
    8. **Overflow warning**: When fruits stack high, the bucket rim should start glowing red as fruits approach the overflow dashed line.
    9. **Game over**: Let a fruit stay above the overflow line for 2+ seconds. "GAME OVER" should appear. Confirm it does NOT trigger from brief bounces above the line.
    10. **Watermelon merge**: (Advanced test) If you can get two watermelons, they should vanish when they touch -- no new fruit spawns, no crash.

    **What to look for (potential issues):**
    - Fruits passing through bucket walls (tunneling)
    - Fruits jittering/vibrating when stacked
    - Two fruits appearing from one merge (double-merge bug)
    - Game crash during rapid merges
    - Game over triggering unfairly during normal play
    - Drop guide line not aligning with actual drop position
  </action>
  <verify>Human runs the game via F5 in Godot editor and plays through the 10-point checklist above.</verify>
  <done>Human types "approved" confirming the Phase 1 game loop plays correctly, or describes issues that need fixing.</done>
</task>

</tasks>

<verification>
1. Complete game loop: drop -> stack -> merge -> overflow -> game over
2. Overflow detection: 2-second continuous dwell timer, no false positives
3. Bucket rim glow: progressively red as overflow approaches
4. HUD: score display (showing 0 for now) + next-fruit preview
5. Game over: clear "GAME OVER" text displayed
6. No physics errors, crashes, or visual glitches
7. 20+ fruits stack without jitter
8. Human playtest verification confirms satisfying game feel
</verification>

<success_criteria>
- OverflowDetector triggers game over after 2s continuous dwell above overflow line
- No false game-overs from bounces, drops, or merge grace periods
- Bucket rim glows red proportional to overflow danger (0% to 100%)
- HUD displays current score and next fruit preview
- Next-fruit preview updates after each drop
- Game over state is clearly communicated via HUD
- Human playtester approves the complete Phase 1 experience
</success_criteria>

<output>
After completion, create `.planning/phases/01-core-physics-merging/01-03-SUMMARY.md`
</output>
