---
phase: 02-scoring-chain-reactions
plan: 02
type: execute
wave: 2
depends_on: ["02-01"]
files_modified:
  - scenes/ui/floating_score.tscn
  - scenes/ui/floating_score.gd
  - scenes/ui/hud.tscn
  - scenes/ui/hud.gd
  - scenes/game/game.tscn
autonomous: false

must_haves:
  truths:
    - "Every merge shows a floating score popup at the merge point that rises and fades"
    - "Chain merges show multiplier in popup (e.g., '+64 x3!') and a prominent chain counter"
    - "Score counter animates with roll-up counting and scale punch on big gains"
    - "Coin counter is visible in the HUD and updates when coins are awarded"
    - "Chain counter only appears for chain_count >= 2 (no 'CHAIN x1!' spam)"
  artifacts:
    - path: "scenes/ui/floating_score.tscn"
      provides: "Floating score popup scene"
    - path: "scenes/ui/floating_score.gd"
      provides: "Popup animation script"
      contains: "func show_score"
    - path: "scenes/ui/hud.gd"
      provides: "Animated score, chain counter, coin display"
      contains: "animate_score_to"
    - path: "scenes/ui/hud.tscn"
      provides: "ChainLabel and CoinLabel nodes"
      contains: "ChainLabel"
  key_links:
    - from: "scenes/ui/hud.gd"
      to: "scripts/autoloads/event_bus.gd"
      via: "EventBus.score_awarded.connect and EventBus.coins_awarded.connect"
      pattern: "score_awarded\\.connect|coins_awarded\\.connect"
    - from: "scenes/ui/floating_score.gd"
      to: "scenes/ui/hud.gd or score_manager.gd"
      via: "Spawned at merge position by score_awarded listener"
      pattern: "floating_score"
    - from: "scenes/game/game.tscn"
      to: "scenes/ui/floating_score.tscn"
      via: "PopupContainer Node2D for world-space popups"
      pattern: "popup_container"
---

<objective>
Create floating score popups at merge positions, add animated score counter with roll-up and scale punch, add chain counter display for cascade merges, and add coin counter to HUD. Add PopupContainer to game scene for world-space popup positioning.

Purpose: This is the visual feedback layer that makes scoring feel exciting. Floating popups give instant per-merge feedback, the chain counter builds hype during cascades, and the animated score counter makes big gains feel impactful. Coins appear in the HUD for Phase 5 shop economy awareness.
Output: FloatingScore scene, updated HUD with chain/coin displays and animated score, PopupContainer in game scene.
</objective>

<execution_context>
@/home/zycroft/.claude/get-shit-done/workflows/execute-plan.md
@/home/zycroft/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/02-scoring-chain-reactions/02-CONTEXT.md
@.planning/phases/02-scoring-chain-reactions/02-RESEARCH.md
@.planning/phases/02-scoring-chain-reactions/02-01-SUMMARY.md

Key existing files to read before implementing:
@scenes/ui/hud.tscn
@scenes/ui/hud.gd
@scenes/game/game.tscn
@scripts/autoloads/event_bus.gd
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create FloatingScore popup scene and update HUD with animated score, chain counter, and coin display</name>
  <files>
    scenes/ui/floating_score.tscn
    scenes/ui/floating_score.gd
    scenes/ui/hud.tscn
    scenes/ui/hud.gd
    scenes/game/game.tscn
  </files>
  <action>
    **FloatingScore scene (scenes/ui/floating_score.tscn + floating_score.gd):**

    Create a new scene with a Label as root node, script attached. The scene file (.tscn) should configure:
    - Root Label node with default font_size ~28, white text, black outline (size 3), horizontal_alignment=CENTER
    - mouse_filter = 2 (IGNORE) -- critical lesson from Phase 1
    - pivot_offset will be set at runtime after text is assigned (research pitfall #3)

    The script (floating_score.gd) should have a single public function:
    ```
    func show_score(text_value: String, start_pos: Vector2, is_chain: bool) -> void
    ```

    Implementation:
    1. Set `text = text_value`
    2. Set `global_position = start_pos` with small random x offset (`randf_range(-20.0, 20.0)`) to prevent stacking
    3. Set `pivot_offset = size / 2.0` for centered scaling (MUST be after text is set so size is correct)
    4. Create a parallel tween:
       - Rise: `tween_property(self, "position:y", position.y - 80.0, 0.8)` with TRANS_QUAD, EASE_OUT
       - Fade: `tween_property(self, "modulate:a", 0.0, 0.8)` with TRANS_QUAD, EASE_IN
    5. If is_chain: add scale punch -- scale to Vector2(1.5, 1.5) over 0.15s (TRANS_BACK, EASE_OUT), then back to Vector2.ONE over 0.3s
    6. Final callback: `tween.chain().tween_callback(queue_free)` -- CRITICAL to prevent popup accumulation (research pitfall #2)

    For chain popups, use a slightly larger font or different color to distinguish. A simple approach: if is_chain, set `modulate = Color(1.0, 0.9, 0.3, 1.0)` (gold tint) before starting the tween.

    **HUD updates (scenes/ui/hud.tscn):**

    Read the existing hud.tscn first. Add these new nodes:
    1. **ChainLabel** (Label): Positioned near center-top of screen (e.g., offset_left=340, offset_top=100, offset_right=740, offset_bottom=160). Font size ~36, gold/yellow color (Color(1.0, 0.85, 0.2, 1.0)), centered, outline. mouse_filter=2. visible=false by default.
    2. **CoinLabel** (Label): Positioned near the score label area (e.g., offset_left=390, offset_top=80, offset_right=690, offset_bottom=120). Font size ~24, lighter/secondary color. mouse_filter=2. Prepend with a coin icon character or text like "Coins: 0". Centered alignment.

    **HUD script updates (scenes/ui/hud.gd):**

    1. **Replace `update_score` with `animate_score_to`:** Add `var _displayed_score: int = 0` and `var _score_tween: Tween = null`. When `animate_score_to(new_score: int)` is called:
       - Kill previous _score_tween if valid (prevents overlapping tweens -- research pitfall #5)
       - Create new tween
       - Use `tween_method(_set_score_text, _displayed_score, new_score, 0.4)` with TRANS_QUAD, EASE_OUT for roll-up
       - Set `$ScoreLabel.pivot_offset = $ScoreLabel.size / 2.0` before scale punch
       - Scale punch: scale to Vector2(1.2, 1.2) over 0.1s (TRANS_BACK, EASE_OUT), then back to Vector2.ONE over 0.2s
       - Update `_displayed_score = new_score` immediately (the tween visually interpolates the display)
       - `_set_score_text(value: int)` just does `$ScoreLabel.text = str(value)`

    2. **Connect new EventBus signals in _ready():**
       - `EventBus.score_awarded.connect(_on_score_awarded)` -- replaces the old fruit_merged connection for score display
       - `EventBus.chain_ended.connect(_on_chain_ended)`
       - `EventBus.coins_awarded.connect(_on_coins_awarded)`
       - Remove the old `EventBus.fruit_merged.connect(_on_fruit_merged)` connection (ScoreManager now handles fruit_merged; HUD listens to score_awarded instead)

    3. **_on_score_awarded(points, position, chain_count, multiplier):**
       - Call `animate_score_to(GameManager.score)` to update the score display with animation
       - Spawn a FloatingScore popup: preload the scene, instantiate, get the popup_container via `get_tree().get_first_node_in_group("popup_container")`, add child, call `show_score()` with formatted text
       - Format text: `"+%d" % points` for normal merges, `"+%d x%d!" % [points, multiplier]` for chains (multiplier > 1)
       - Call `show_chain(chain_count, multiplier)` to update chain display

    4. **show_chain(chain_count, multiplier):**
       - If chain_count < 2: hide $ChainLabel, return (research pitfall #6 -- no "CHAIN x1!")
       - Show $ChainLabel with text `"CHAIN x%d!" % multiplier`
       - Set pivot_offset for centered scaling
       - Scale punch: 1.3x over 0.1s, back to 1.0 over 0.2s
       - Kill any previous chain tween to prevent overlap

    5. **_on_chain_ended(chain_length):**
       - Hide $ChainLabel (optionally fade out over 0.3s)

    6. **_on_coins_awarded(new_coins, total_coins):**
       - Update `$CoinLabel.text = "Coins: %d" % total_coins` (HUD-only display per discretion decision)
       - Small scale punch on CoinLabel (1.15x over 0.1s, back over 0.15s)
       - Set pivot_offset before punch

    7. **Initialize coins display** in _ready(): `$CoinLabel.text = "Coins: %d" % GameManager.coins`

    **game.tscn:** Add a `PopupContainer` Node2D as a child of Game (after FruitContainer, before MergeManager). Add it to group "popup_container". This is where floating score popups are spawned in world space (NOT on the CanvasLayer HUD). Read the existing game.tscn first and follow the same formatting pattern.

    Preload the floating_score scene in hud.gd:
    ```
    var _floating_score_scene: PackedScene = preload("res://scenes/ui/floating_score.tscn")
    ```
  </action>
  <verify>
    Verify floating_score.tscn and floating_score.gd exist.
    Verify floating_score.gd contains show_score function with tween animation and queue_free callback.
    Verify hud.tscn contains ChainLabel and CoinLabel nodes.
    Verify hud.gd connects to score_awarded, chain_ended, coins_awarded signals.
    Verify hud.gd has animate_score_to with roll-up tween and scale punch.
    Verify hud.gd has show_chain that hides when chain_count < 2.
    Verify game.tscn has PopupContainer Node2D in group "popup_container".
    Verify hud.gd no longer directly connects to fruit_merged for score display.
  </verify>
  <done>
    FloatingScore popup scene spawns at merge positions, rises, and fades. Chain merges show gold-tinted popups with multiplier text. HUD score counter animates with roll-up and scale punch. Chain counter appears prominently during cascades (hidden for single merges). Coin counter displays in HUD and punches on gain. PopupContainer exists in game scene for world-space popup spawning.
  </done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <name>Task 2: Playtest scoring, chains, and coin economy</name>
  <files>none (verification only)</files>
  <action>
    Human playtests the complete Phase 2 scoring system. Run the project in Godot (F5) and verify all scoring mechanics work correctly.

    **What was built:**
    Complete Phase 2 scoring system: exponential point values (powers of 2), cascade-based chain tracking with accelerating multipliers, floating score popups at merge points, animated HUD score counter, chain counter display, and score-derived coin economy.

    **Playtest checklist:**
    1. **Basic scoring:** Drop and merge two blueberries. A floating "+2" popup should appear at the merge point and rise/fade. The HUD score should animate up to 2.
    2. **Higher tier scoring:** Merge grapes (should award +4), cherries (+8), etc. Verify each tier awards roughly double the previous.
    3. **Chain reaction:** Try to set up a cascade where a merge result immediately triggers another merge. During the chain:
       - Each popup should show the multiplier (e.g., "+8 x2!" for the second merge in a chain)
       - A "CHAIN x2!" (or higher) label should appear prominently
       - Chain popups should be gold-tinted and slightly larger
    4. **Chain reset:** After a chain ends (no merge for ~1 second), the chain counter should disappear. The next single merge should NOT show "CHAIN x1!".
    5. **Coins:** Watch the coin counter in the HUD. After accumulating 100+ total score, it should show "Coins: 1". After 200+ total score, "Coins: 2", etc.
    6. **Watermelon bonus:** If reachable, merging two watermelons should award +1000 with a popup.
    7. **No visual bugs:** Score label should scale-punch from center (not jump around). Floating popups should not accumulate (check scene tree in debugger if unsure). No errors in the Godot output panel.
  </action>
  <verify>User confirms all scoring, chain, popup, and coin behaviors work as expected with no visual or logic bugs.</verify>
  <done>Playtest approved: scoring, chains, popups, and coins all function correctly. Phase 2 is complete.</done>
</task>

</tasks>

<verification>
After both tasks:
1. Merging fruits spawns a floating score popup at the merge position that rises and fades out
2. Single merges show "+N" format, chain merges show "+N xM!" format with gold tint
3. Chain counter ("CHAIN xM!") appears during cascades, hidden for single merges
4. Score counter in HUD animates (counts up) and punches on update
5. Coin counter shows cumulative coins (1 per 100 score)
6. No popup accumulation (nodes freed after animation)
7. No score label pivot issues (scales from center)
8. No "CHAIN x1!" spam on single merges
</verification>

<success_criteria>
- Every merge produces a visible floating popup with correct point value
- Chain merges show escalating multipliers and a prominent chain counter
- Score animates smoothly with scale punch on big gains
- Coins display in HUD and increment at 100-score thresholds
- All visual elements are properly positioned and animated
- Playtest approved by user
</success_criteria>

<output>
After completion, create `.planning/phases/02-scoring-chain-reactions/02-02-SUMMARY.md`
</output>
