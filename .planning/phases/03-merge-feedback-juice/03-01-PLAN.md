---
phase: 03-merge-feedback-juice
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - scripts/components/screen_shake.gd
  - scripts/autoloads/sfx_manager.gd
  - scenes/effects/merge_particles.tscn
  - project.godot
autonomous: true

must_haves:
  truths:
    - "Camera2D exists in game scene with trauma-based shake that decays smoothly"
    - "SfxManager autoload can play overlapping sounds without cutoff"
    - "CPUParticles2D scene produces a one-shot radial burst that auto-frees"
  artifacts:
    - path: "scripts/components/screen_shake.gd"
      provides: "Camera2D script with trauma-based FastNoiseLite shake"
      contains: "add_trauma"
    - path: "scripts/autoloads/sfx_manager.gd"
      provides: "Audio pool with 8 players and pitch/volume scaling by tier"
      contains: "play_merge"
    - path: "scenes/effects/merge_particles.tscn"
      provides: "One-shot CPUParticles2D burst scene"
      contains: "CPUParticles2D"
  key_links:
    - from: "scripts/components/screen_shake.gd"
      to: "Camera2D node in game.tscn"
      via: "shake_camera group membership"
      pattern: "add_to_group.*shake_camera"
    - from: "scripts/autoloads/sfx_manager.gd"
      to: "project.godot"
      via: "autoload registration"
      pattern: "SfxManager"
---

<objective>
Create the three feedback infrastructure systems (screen shake, SFX pool, particle scene) that Phase 3 requires. These are standalone building blocks that MergeFeedback (Plan 02) will orchestrate.

Purpose: Provides the Camera2D shake, audio pool, and particle burst systems needed before the MergeFeedback orchestrator can wire them to merge events.
Output: screen_shake.gd, sfx_manager.gd, merge_particles.tscn, updated project.godot with SfxManager autoload.
</objective>

<execution_context>
@/home/zycroft/.claude/get-shit-done/workflows/execute-plan.md
@/home/zycroft/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/03-merge-feedback-juice/03-RESEARCH.md
@scripts/autoloads/event_bus.gd
@scenes/game/game.tscn
@project.godot
</context>

<tasks>

<task type="auto">
  <name>Task 1: Screen shake Camera2D and SFX pool autoload</name>
  <files>
    scripts/components/screen_shake.gd
    scripts/autoloads/sfx_manager.gd
    project.godot
  </files>
  <action>
Create two new scripts:

**scripts/components/screen_shake.gd** -- Camera2D script with trauma-based shake:
- `extends Camera2D`, add to group "shake_camera" in _ready()
- Properties: `@export var decay: float = 0.8`, `@export var max_offset: Vector2 = Vector2(12, 8)`, `@export var max_roll: float = 0.02`
- Internal state: `var trauma: float = 0.0`, `var trauma_power: int = 2`
- FastNoiseLite: create in _ready(), seed = randi(), noise_type = TYPE_SIMPLEX, frequency = 0.5
- `func add_trauma(amount: float) -> void`: `trauma = minf(trauma + amount, 1.0)`
- `_process(delta)`: if trauma > 0, decay it by `decay * delta`, then call `_apply_shake()`. If trauma is 0, reset offset and rotation to zero.
- `_apply_shake()`: amount = pow(trauma, trauma_power). Advance noise_y by 1.0 each call. Compute offset.x, offset.y, and rotation from noise using different seed multipliers for each axis. See research Pattern 2.
- Position will be set to viewport center (540, 960) when added to game.tscn in Plan 02.

**scripts/autoloads/sfx_manager.gd** -- SFX audio pool:
- `extends Node`, POOL_SIZE = 8
- _ready(): create 8 AudioStreamPlayer children, set bus = "SFX", connect finished signal to recycler, push to _available array. Check if "SFX" bus exists with AudioServer.get_bus_index(); if -1, push_warning and omit bus assignment (will default to Master).
- `func play_merge(tier: int, intensity: float) -> void`: pop from _available, set stream = preloaded merge_pop.wav, set pitch_scale = lerpf(1.3, 0.7, intensity) + randf_range(-0.05, 0.05), volume_db = lerpf(-6.0, 0.0, intensity), play(). If pool empty, return silently.
- `func play_chain_accent(chain_count: int) -> void`: pop from _available, set stream = preloaded merge_pop.wav (same file, reused), pitch_scale = lerpf(1.5, 2.0, clampf(float(chain_count - 2) / 5.0, 0.0, 1.0)) for ascending ding feel, volume_db = -3.0, play().
- `func play_watermelon_vanish() -> void`: pop from _available, stream = merge_pop.wav, pitch_scale = 0.5 (deep boom), volume_db = 2.0, play().
- `_on_finished(player)`: append player back to _available.
- Note: All three play functions use the same merge_pop.wav with different pitch/volume. When a real audio file is not present yet, use a dynamically generated placeholder (see Task 2 below for WAV generation).

**project.godot** -- Add SfxManager autoload:
- Add line under [autoload]: `SfxManager="*res://scripts/autoloads/sfx_manager.gd"`
- Add audio bus layout file reference if not present. If default_bus_layout doesn't exist, create a simple one in Task 2 or let SfxManager gracefully handle missing SFX bus (it already does via the push_warning fallback).
  </action>
  <verify>
Open project in Godot editor (or review files): screen_shake.gd has add_trauma method, sfx_manager.gd has play_merge/play_chain_accent/play_watermelon_vanish methods, project.godot has SfxManager autoload line. No parse errors in GDScript.
  </verify>
  <done>
screen_shake.gd exists with trauma-based Camera2D shake using FastNoiseLite. sfx_manager.gd exists with 8-player pool and tier-scaled pitch/volume. SfxManager registered as autoload in project.godot.
  </done>
</task>

<task type="auto">
  <name>Task 2: Particle burst scene and placeholder audio</name>
  <files>
    scenes/effects/merge_particles.tscn
    assets/audio/sfx/merge_pop.wav
  </files>
  <action>
**scenes/effects/merge_particles.tscn** -- Create a CPUParticles2D scene file (.tscn format):
- Root node: CPUParticles2D named "MergeParticles"
- Properties (set in the .tscn resource):
  - emitting = false (will be started by code)
  - amount = 16 (default, overridden per-spawn)
  - one_shot = true
  - explosiveness = 1.0 (all particles at once)
  - lifetime = 0.4
  - emission_shape = 1 (EMISSION_SHAPE_SPHERE)
  - emission_sphere_radius = 5.0
  - direction = Vector2(0, -1)
  - spread = 180.0 (full circle)
  - gravity = Vector2(0, 200)
  - initial_velocity_min = 60.0
  - initial_velocity_max = 120.0
  - scale_amount_min = 2.0
  - scale_amount_max = 4.0
- Do NOT connect finished->queue_free in the scene (known editor crash bug #107743). Connection happens at spawn time in MergeFeedback (Plan 02).

**assets/audio/sfx/merge_pop.wav** -- Generate a minimal valid WAV file:
- Create the assets/audio/sfx/ directory if it doesn't exist.
- Generate a simple sine wave pop sound as a minimal WAV file using a GDScript tool script or write raw bytes. The simplest approach: create a very short (0.1-0.2 second) 44100Hz 16-bit mono WAV file with a sine wave burst that decays. This is a placeholder that will be replaced with polished audio later.
- Alternative: if generating WAV programmatically is too complex inline, create a minimal valid WAV file (even just a click/blip) so SfxManager doesn't error on preload. The file just needs to be a valid WAV. A Python one-liner can generate this: `python3 -c "import struct,math;f=open('merge_pop.wav','wb');sr=44100;d=0.15;n=int(sr*d);f.write(b'RIFF'+struct.pack('<I',36+n*2)+b'WAVEfmt '+struct.pack('<IHHIIHH',16,1,1,sr,sr*2,2,16)+b'data'+struct.pack('<I',n*2)+b''.join(struct.pack('<h',int(32767*math.sin(2*math.pi*880*i/sr)*max(0,1-i/(sr*d)))) for i in range(n)));f.close()"`
  </action>
  <verify>
The file scenes/effects/merge_particles.tscn exists and is valid .tscn format with CPUParticles2D root. The file assets/audio/sfx/merge_pop.wav exists and is a valid WAV file (non-zero size). Run `file assets/audio/sfx/merge_pop.wav` to confirm WAV format detection.
  </verify>
  <done>
merge_particles.tscn exists with one-shot CPUParticles2D configured for radial burst. merge_pop.wav exists as a valid placeholder audio file that SfxManager can preload without errors.
  </done>
</task>

</tasks>

<verification>
- scripts/components/screen_shake.gd exists with add_trauma(), _process() shake decay, FastNoiseLite noise
- scripts/autoloads/sfx_manager.gd exists with play_merge(), play_chain_accent(), play_watermelon_vanish(), 8-player pool
- scenes/effects/merge_particles.tscn exists with one_shot CPUParticles2D
- assets/audio/sfx/merge_pop.wav exists as valid WAV
- project.godot has SfxManager autoload entry
- No finished->queue_free connection in the particle scene file
</verification>

<success_criteria>
All three feedback infrastructure systems (shake, audio, particles) exist as standalone files ready for MergeFeedback to orchestrate in Plan 02. SfxManager is registered as autoload. Placeholder audio prevents preload errors.
</success_criteria>

<output>
After completion, create `.planning/phases/03-merge-feedback-juice/03-01-SUMMARY.md`
</output>
