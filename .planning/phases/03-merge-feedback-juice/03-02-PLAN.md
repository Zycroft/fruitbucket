---
phase: 03-merge-feedback-juice
plan: 02
type: execute
wave: 2
depends_on: ["03-01"]
files_modified:
  - scripts/components/merge_feedback.gd
  - scenes/game/game.tscn
  - scenes/game/game.gd
autonomous: false

must_haves:
  truths:
    - "Every merge produces a particle burst colored by the created fruit's FruitData.color"
    - "Every merge produces screen shake that increases with fruit tier"
    - "Every merge plays a sound effect with pitch/volume scaled by tier"
    - "Chain reactions (2+ merges) produce escalating shake and accent sounds"
    - "A 3+ chain reaction is visually and audibly distinct from a single merge"
    - "Watermelon vanish produces gold particles, maximum shake, and deep boom sound"
  artifacts:
    - path: "scripts/components/merge_feedback.gd"
      provides: "Orchestrates particles, shake, and SFX on merge events"
      contains: "_on_fruit_merged"
    - path: "scenes/game/game.tscn"
      provides: "Camera2D, EffectsContainer, and MergeFeedback nodes"
      contains: "ShakeCamera"
  key_links:
    - from: "scripts/components/merge_feedback.gd"
      to: "scripts/autoloads/event_bus.gd"
      via: "signal connection in _ready()"
      pattern: "EventBus\\.fruit_merged\\.connect"
    - from: "scripts/components/merge_feedback.gd"
      to: "scripts/autoloads/sfx_manager.gd"
      via: "SfxManager.play_merge() call"
      pattern: "SfxManager\\.play_merge"
    - from: "scripts/components/merge_feedback.gd"
      to: "scripts/components/screen_shake.gd"
      via: "group lookup shake_camera, add_trauma()"
      pattern: "shake_camera.*add_trauma"
    - from: "scripts/components/merge_feedback.gd"
      to: "scenes/effects/merge_particles.tscn"
      via: "preload and instantiate at merge position"
      pattern: "preload.*merge_particles"
---

<objective>
Wire the MergeFeedback orchestrator to connect EventBus merge signals to the particle, shake, and SFX infrastructure from Plan 01. Add Camera2D, EffectsContainer, and MergeFeedback nodes to the game scene. Implement chain escalation and watermelon vanish special treatment.

Purpose: Completes Phase 3 by making merges produce scaled multi-sensory feedback, making the core loop feel satisfying and chain reactions spectacle-worthy.
Output: merge_feedback.gd, updated game.tscn with all feedback nodes, working merge juice verified by playtest.
</objective>

<execution_context>
@/home/zycroft/.claude/get-shit-done/workflows/execute-plan.md
@/home/zycroft/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/03-merge-feedback-juice/03-RESEARCH.md
@.planning/phases/03-merge-feedback-juice/03-01-SUMMARY.md
@scripts/autoloads/event_bus.gd
@scripts/components/score_manager.gd
@scenes/game/game.tscn
@scenes/game/game.gd
</context>

<tasks>

<task type="auto">
  <name>Task 1: MergeFeedback component and game scene integration</name>
  <files>
    scripts/components/merge_feedback.gd
    scenes/game/game.tscn
  </files>
  <action>
**scripts/components/merge_feedback.gd** -- Central feedback orchestrator:
- `class_name MergeFeedback`, `extends Node`
- Preload: `var _particle_scene: PackedScene = preload("res://scenes/effects/merge_particles.tscn")`
- Load all 8 FruitData resources in _ready() (same _load_fruit_types() pattern as ScoreManager and MergeManager)
- Connect to `EventBus.fruit_merged` and `EventBus.score_awarded` in _ready()
- Add to group "merge_feedback" in _ready()

**_on_fruit_merged(old_tier: int, new_tier: int, merge_pos: Vector2):**
- Calculate tier_intensity: `clampf(float(new_tier) / 7.0, 0.1, 1.0)`, capped at 1.0 for new_tier >= 8
- Call `_spawn_particles(merge_pos, new_tier, tier_intensity)`
- Call `_trigger_shake(tier_intensity * 0.3)` -- base shake scaled by tier (0.3 max for single merge to leave room for chain escalation)
- Call `SfxManager.play_merge(new_tier, tier_intensity)`
- If new_tier >= _fruit_types.size() (watermelon vanish): call `_on_watermelon_vanish(merge_pos)` for extra special treatment

**_spawn_particles(pos: Vector2, tier: int, intensity: float):**
- Instantiate _particle_scene
- Find effects container: `get_tree().get_first_node_in_group("effects_container")`. If not found, fall back to `get_tree().get_first_node_in_group("fruit_container")`.
- Add particle instance as child of container
- Set global_position = pos (AFTER adding to container tree)
- Call `_configure_particles(particles, tier, intensity)`
- Connect `particles.finished.connect(particles.queue_free)` (runtime-only, avoids editor crash bug)
- Set `particles.emitting = true`

**_configure_particles(particles: CPUParticles2D, tier: int, intensity: float):**
- Get color from FruitData: if tier < _fruit_types.size(), use _fruit_types[tier].color, else Color(1.0, 0.9, 0.3) (gold for watermelon vanish)
- Set particles.color = color
- Create Gradient for color_ramp: color at position 0 -> transparent (same RGB, alpha 0) at position 1
- Set particles.color_ramp = gradient
- Scale particle count: particles.amount = int(lerpf(8.0, 30.0, intensity))
- Scale velocity: particles.initial_velocity_min = lerpf(40.0, 120.0, intensity), particles.initial_velocity_max = lerpf(80.0, 200.0, intensity)
- Scale size: particles.scale_amount_min = lerpf(1.5, 4.0, intensity), particles.scale_amount_max = lerpf(3.0, 8.0, intensity)

**_trigger_shake(trauma_amount: float):**
- Find camera: `get_tree().get_first_node_in_group("shake_camera")`
- If camera exists and has method "add_trauma": call camera.add_trauma(trauma_amount)

**_on_score_awarded(points: int, position: Vector2, chain_count: int, multiplier: int):**
- If chain_count < 2: return (no chain bonus for single merges)
- Add extra shake: `var extra_trauma: float = minf(0.15, 0.08 + float(chain_count - 2) * 0.02)` -- diminishing addition to avoid shake overload
- Call `_trigger_shake(extra_trauma)`
- If chain_count >= 3: call `SfxManager.play_chain_accent(chain_count)` -- ascending ding for 3+ chains

**_on_watermelon_vanish(merge_pos: Vector2):**
- Spawn extra-large gold particle burst: instantiate another _particle_scene, add to effects container at merge_pos
- Configure: amount = 40, color = Color(1.0, 0.9, 0.3) gold, gradient to transparent, initial_velocity_min = 150, initial_velocity_max = 300, lifetime = 0.8, scale_amount_min = 4.0, scale_amount_max = 10.0
- Connect finished->queue_free, set emitting = true
- Extra shake: _trigger_shake(0.6) -- big trauma burst
- Call SfxManager.play_watermelon_vanish()

**scenes/game/game.tscn** -- Add three new nodes:
1. **ShakeCamera** (Camera2D) -- child of Game root, position = Vector2(540, 960) (viewport center), script = screen_shake.gd, groups = ["shake_camera"]. Must be above other visual nodes in tree for correct rendering.
2. **EffectsContainer** (Node2D) -- child of Game root, groups = ["effects_container"]. Place AFTER FruitContainer in tree order so effects render on top of fruits.
3. **MergeFeedback** (Node) -- child of Game root, script = merge_feedback.gd, groups = ["merge_feedback"]. Place after ScoreManager since it depends on the same signals.

Tree order in game.tscn after changes:
```
Game (Node2D)
  Background
  ShakeCamera (Camera2D) [NEW]
  Bucket
  FruitContainer
  EffectsContainer [NEW]
  PopupContainer
  MergeManager
  ScoreManager
  MergeFeedback [NEW]
  DropController
    DropGuide
  OverflowDetector
    CollisionShape2D
  HUD
```

Important: The HUD is a CanvasLayer, so Camera2D offset does NOT affect it -- this is the correct behavior (UI should not shake).
  </action>
  <verify>
Review merge_feedback.gd for: EventBus.fruit_merged.connect in _ready(), _spawn_particles uses effects_container group, _configure_particles uses FruitData.color, chain escalation in _on_score_awarded, watermelon vanish special treatment. Review game.tscn for ShakeCamera, EffectsContainer, MergeFeedback nodes. Run the game and trigger a merge -- particle burst + shake + sound should occur.
  </verify>
  <done>
MergeFeedback orchestrates all three feedback channels (particles, shake, SFX) on every merge. Tier intensity scales all three proportionally. Chain reactions add extra shake and accent sounds. Watermelon vanish produces maximum spectacle with gold particles and deep boom.
  </done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <name>Task 2: Playtest merge feedback</name>
  <what-built>
Complete merge feedback system: particle bursts colored by fruit tier, screen shake scaling with tier and chain, SFX with pitch/volume variation, chain escalation (extra shake + accent for 2+ chains), and watermelon vanish special treatment (gold burst, maximum shake, deep boom). HUD should NOT shake (CanvasLayer isolation).
  </what-built>
  <how-to-verify>
1. Run the game (F5 in Godot or launch the scene)
2. Drop two same-tier fruits to trigger a merge:
   - Verify: particle burst appears at merge point in the fruit's color
   - Verify: brief screen shake occurs (subtle for tier 0-1)
   - Verify: pop sound plays
3. Trigger a chain reaction (drop a fruit that causes 2+ consecutive merges):
   - Verify: shake escalates with each merge in the chain
   - Verify: chain accent sound plays on 3rd+ merge (higher pitch ding)
   - Verify: the chain feels distinctly more intense than a single merge
4. Verify HUD stability during shake:
   - Score label, chain counter, coin display should NOT jitter
5. Drop many small fruits to build up -- verify no performance issues with particles
6. (Optional) If achievable: trigger watermelon vanish to see gold burst + big shake + deep sound
  </how-to-verify>
  <resume-signal>Type "approved" or describe any issues with particle appearance, shake feel, sound, chain escalation, or HUD stability</resume-signal>
</task>

</tasks>

<verification>
- Every merge produces visible particles at merge position colored by FruitData.color
- Every merge produces screen shake proportional to tier (subtle for low tiers, strong for high)
- Every merge plays a pop sound with tier-scaled pitch (high pitch for small fruits, low for big)
- Chain reactions (2+ merges) produce additive shake + accent sounds
- 3+ chain is visually and audibly distinct from single merge
- HUD does not shake (CanvasLayer isolation from Camera2D offset)
- Watermelon vanish produces gold burst, maximum shake, deep boom
- No particle-related crashes or performance issues during chains
</verification>

<success_criteria>
A player can tell the difference between a single merge and a 3+ chain reaction purely from visual and audio feedback without looking at the score. Every merge tier has a proportionally distinct feel. The game loop feels satisfying and rewarding. HUD remains stable during all effects.
</success_criteria>

<output>
After completion, create `.planning/phases/03-merge-feedback-juice/03-02-SUMMARY.md`
</output>
