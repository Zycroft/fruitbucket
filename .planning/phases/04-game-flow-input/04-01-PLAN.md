---
phase: 04-game-flow-input
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - scripts/autoloads/game_manager.gd
  - scripts/autoloads/event_bus.gd
  - scenes/ui/pause_menu.tscn
  - scenes/ui/pause_menu.gd
  - scenes/ui/hud.tscn
  - scenes/ui/hud.gd
  - scenes/game/game.tscn
  - scripts/components/drop_controller.gd
autonomous: false

must_haves:
  truths:
    - "Player can press Escape or tap a pause button and all gameplay freezes (physics, fruits, merges)"
    - "Player can resume from the pause menu and gameplay continues exactly where it left off"
    - "Player can restart from the pause menu and get a completely fresh run (score 0, no fruits, no chain state)"
    - "Player can quit from the pause menu (acts as restart since no title screen exists yet)"
    - "Touch input positions and drops fruits with the same precision as mouse input"
    - "All buttons in pause menu and HUD work on both desktop (click) and mobile (tap)"
  artifacts:
    - path: "scenes/ui/pause_menu.tscn"
      provides: "Pause menu overlay with Resume, Restart, Quit buttons"
      contains: "CanvasLayer"
    - path: "scenes/ui/pause_menu.gd"
      provides: "Pause menu logic: toggle visibility, resume/restart/quit handlers"
      min_lines: 30
    - path: "scripts/autoloads/game_manager.gd"
      provides: "PAUSED state in GameState enum, tree pause management in change_state"
      contains: "PAUSED"
    - path: "scenes/ui/hud.tscn"
      provides: "Touch-friendly pause button in top-left corner"
      contains: "PauseButton"
  key_links:
    - from: "scenes/ui/pause_menu.gd"
      to: "scripts/autoloads/game_manager.gd"
      via: "GameManager.change_state(GameState.PAUSED) and get_tree().paused"
      pattern: "GameManager\\.change_state"
    - from: "scenes/ui/pause_menu.gd"
      to: "get_tree()"
      via: "unpause before reload_current_scene for restart"
      pattern: "paused\\s*=\\s*false.*reload_current_scene"
    - from: "scenes/ui/hud.gd"
      to: "scripts/autoloads/event_bus.gd"
      via: "Pause button emits pause_requested signal"
      pattern: "pause_requested"
    - from: "scenes/game/game.tscn"
      to: "scenes/ui/pause_menu.tscn"
      via: "PauseMenu instanced as child of Game scene"
      pattern: "pause_menu"
---

<objective>
Add pause menu with resume/restart/quit, a HUD pause button for touch, and verify dual-platform input.

Purpose: Players need game flow controls (pause, restart) to manage their runs, and touch input must work equally well as mouse for the web-deployed game on mobile devices.

Output: Working pause/resume/restart flow, touch-friendly pause button in HUD, verified touch input parity.
</objective>

<execution_context>
@/home/zycroft/.claude/get-shit-done/workflows/execute-plan.md
@/home/zycroft/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/04-game-flow-input/04-RESEARCH.md
@scripts/autoloads/game_manager.gd
@scripts/autoloads/event_bus.gd
@scripts/components/drop_controller.gd
@scenes/ui/hud.gd
@scenes/ui/hud.tscn
@scenes/game/game.tscn
@scenes/game/game.gd
</context>

<tasks>

<task type="auto">
  <name>Task 1: GameManager PAUSED state, PauseMenu scene, and HUD pause button</name>
  <files>
    scripts/autoloads/game_manager.gd
    scripts/autoloads/event_bus.gd
    scenes/ui/pause_menu.tscn
    scenes/ui/pause_menu.gd
    scenes/ui/hud.tscn
    scenes/ui/hud.gd
    scenes/game/game.tscn
    scripts/components/drop_controller.gd
  </files>
  <action>
    **1. GameManager -- Add PAUSED state and tree pause management:**

    In `scripts/autoloads/game_manager.gd`:
    - Add `PAUSED` to the `GameState` enum (between WAITING and GAME_OVER).
    - Store `_previous_state: GameState` variable so resume knows which state to return to.
    - Modify `change_state()`: when new_state is `PAUSED`, set `get_tree().paused = true`. When transitioning FROM `PAUSED` to any other state, set `get_tree().paused = false`.
    - Keep GAME_OVER as-is (no tree pause per research Open Question #1 -- fruits keep settling naturally).
    - In `reset_game()`, also reset `_previous_state` and ensure `get_tree().paused = false` is called BEFORE any state change (critical pitfall from research).

    **2. EventBus -- Add pause signal:**

    In `scripts/autoloads/event_bus.gd`:
    - Add `signal pause_requested()` for the HUD pause button to emit.
    - Add `signal resume_requested()` for symmetry (PauseMenu can emit when resuming).

    **3. PauseMenu scene and script:**

    Create `scenes/ui/pause_menu.tscn`:
    - Root: CanvasLayer named "PauseMenu" with `process_mode = PROCESS_MODE_ALWAYS` and `layer = 10` (above HUD).
    - Child: ColorRect named "Overlay" anchored full-rect, color `Color(0, 0, 0, 0.5)`, `mouse_filter = STOP` (blocks clicks through to game).
    - Child: VBoxContainer named "MenuContainer" centered in viewport (use anchors: center preset, offset to center a ~300x400 area). Set `mouse_filter = IGNORE`.
    - In VBoxContainer: Label "PausedLabel" with text "PAUSED", font_size 64, white, centered. Set `mouse_filter = IGNORE`.
    - In VBoxContainer: Button "ResumeButton" with text "Resume", minimum height 64px (touch-friendly, 48dp+ per research).
    - In VBoxContainer: Button "RestartButton" with text "Restart", minimum height 64px.
    - In VBoxContainer: Button "QuitButton" with text "Quit", minimum height 64px.
    - VBoxContainer separation = 20 for comfortable tap spacing.
    - Style buttons with LabelSettings or theme_override: font_size 32, ensure visible contrast.

    Create `scenes/ui/pause_menu.gd`:
    - Extends CanvasLayer.
    - In `_ready()`: set `process_mode = Node.PROCESS_MODE_ALWAYS`, set `visible = false`. Connect button signals: ResumeButton.pressed -> `_on_resume_pressed`, RestartButton.pressed -> `_on_restart_pressed`, QuitButton.pressed -> `_on_quit_pressed`. Connect `EventBus.pause_requested` -> `_on_pause_requested`. Connect `EventBus.game_state_changed` -> `_on_game_state_changed`.
    - `_unhandled_input(event)`: If `event.is_action_pressed("ui_cancel")`: if game is PAUSED, call `_on_resume_pressed()`. Elif game is NOT GAME_OVER and NOT PAUSED, call `_on_pause_requested()`. Call `get_viewport().set_input_as_handled()`.
    - `_on_pause_requested()`: If `GameManager.current_state == GameManager.GameState.GAME_OVER`, return. Set `visible = true`. Call `GameManager.change_state(GameManager.GameState.PAUSED)`.
    - `_on_resume_pressed()`: Set `visible = false`. Call `GameManager.change_state(GameManager._previous_state)` to restore the pre-pause state.
    - `_on_restart_pressed()`: Set `visible = false`. Call `get_tree().paused = false` (CRITICAL: before reload). Call `GameManager.reset_game()`. Call `get_tree().reload_current_scene()`.
    - `_on_quit_pressed()`: Same as restart for now (no title screen). Add a comment: `# TODO: Navigate to title screen when one exists.`
    - `_on_game_state_changed(new_state)`: If new_state is GAME_OVER, hide the pause menu (if somehow open during game over).

    **4. HUD -- Add pause button:**

    In `scenes/ui/hud.tscn`:
    - Add a Button node named "PauseButton" as child of HUD (CanvasLayer root).
    - Position: top-left corner, offset_left = 20, offset_top = 20, minimum size 80x80 (touch-friendly on 1080x1920 viewport).
    - Text: "||" (pause icon as text). Font size 36. `mouse_filter = STOP` (needs to receive clicks).

    In `scenes/ui/hud.gd`:
    - In `_ready()`, connect `$PauseButton.pressed` -> `_on_pause_button_pressed`.
    - `_on_pause_button_pressed()`: If `GameManager.current_state == GameManager.GameState.GAME_OVER`, return. Emit `EventBus.pause_requested.emit()`.
    - In `_on_game_state_changed()`: When PAUSED, hide the PauseButton. When not PAUSED and not GAME_OVER, show it. When GAME_OVER, hide the PauseButton (restart comes from pause menu or future game-over screen).

    **5. Game scene -- Instance PauseMenu:**

    In `scenes/game/game.tscn`:
    - Add PauseMenu as a child of Game, instancing `res://scenes/ui/pause_menu.tscn`. Place it after HUD in the tree.

    **6. DropController -- Add PAUSED guard (belt-and-suspenders):**

    In `scripts/components/drop_controller.gd`:
    - In `_unhandled_input()`, add a PAUSED state check alongside the existing GAME_OVER check. This is belt-and-suspenders since `get_tree().paused = true` already stops `_unhandled_input` on PAUSABLE nodes, but it documents intent and protects against future process_mode changes.
    - Add `TOUCH_PREVIEW_OFFSET` constant (float, default 0.0) with comment explaining it can be tuned if finger occlusion is an issue. Do NOT apply the offset proactively (research recommends the natural 80px gap above bucket rim is sufficient).

    **Important notes:**
    - ALL non-interactive UI elements (Labels, ColorRect in pause menu, containers) must have `mouse_filter = IGNORE` (value 2) EXCEPT the Overlay ColorRect which should be `STOP` to prevent clicks bleeding through to the game, and the Buttons which need `STOP` to receive clicks.
    - The PauseMenu CanvasLayer must use `process_mode = PROCESS_MODE_ALWAYS` (set both in .tscn and defensively in _ready).
    - The VBoxContainer itself should have `mouse_filter = IGNORE` so it does not consume clicks between buttons.
  </action>
  <verify>
    Run `grep -r "PAUSED" scripts/autoloads/game_manager.gd` to confirm PAUSED state exists.
    Run `grep -r "pause_requested" scripts/autoloads/event_bus.gd` to confirm signal exists.
    Verify `scenes/ui/pause_menu.tscn` and `scenes/ui/pause_menu.gd` exist.
    Run `grep -r "pause_menu" scenes/game/game.tscn` to confirm PauseMenu is instanced.
    Run `grep -r "PauseButton" scenes/ui/hud.tscn` to confirm pause button exists.
    Run `grep -r "PAUSED" scripts/components/drop_controller.gd` to confirm guard added.
  </verify>
  <done>
    GameManager has PAUSED state with tree pause management. PauseMenu scene exists with Resume/Restart/Quit buttons on a CanvasLayer with process_mode ALWAYS. HUD has a touch-friendly pause button. PauseMenu is instanced in the game scene. DropController has PAUSED guard and TOUCH_PREVIEW_OFFSET constant. All non-interactive UI elements have mouse_filter = IGNORE.
  </done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <name>Task 2: Playtest pause, restart, and touch input</name>
  <what-built>
    Complete pause/resume/restart system with:
    - Escape key toggles pause menu
    - HUD pause button (touch-friendly, top-left corner)
    - Resume returns to gameplay exactly where it was
    - Restart gives a completely fresh run
    - Quit acts as restart (no title screen yet)
    - Touch input works via emulate_mouse_from_touch (already configured)
  </what-built>
  <how-to-verify>
    Run the game (F5 in Godot or web export).

    **Pause/Resume test:**
    1. Drop a few fruits, let them merge and accumulate score
    2. Press Escape -- game should freeze, dark overlay appears with "PAUSED" label and three buttons
    3. While paused: fruits should be completely frozen in place, no physics, no merges
    4. Click Resume -- overlay disappears, gameplay resumes from exact same state, fruits continue settling
    5. Verify score did not reset on resume

    **Restart test:**
    6. Pause again, click Restart
    7. Scene should reload: score = 0, coins = 0, no fruits in bucket, fresh preview fruit
    8. Drop some fruits to confirm gameplay works normally after restart
    9. Pause and click Quit -- should behave identically to Restart

    **HUD pause button test:**
    10. Click the "||" pause button in top-left corner -- pause menu should open
    11. Resume from it

    **Touch input test (if testing on mobile/touch device):**
    12. Drag finger to position fruit -- preview should track finger horizontally
    13. Tap to drop -- fruit should fall at the positioned X
    14. Tap pause button -- should open pause menu
    15. Tap Resume/Restart buttons -- should respond

    **Edge cases:**
    16. During game over, press Escape -- pause menu should NOT open
    17. During game over, pause button should be hidden
    18. During a chain reaction, pause mid-chain -- fruits should freeze, no new merges while paused
  </how-to-verify>
  <resume-signal>Type "approved" or describe any issues with pause, restart, or input behavior.</resume-signal>
</task>

</tasks>

<verification>
- Escape key opens/closes pause menu
- HUD pause button opens pause menu
- Resume continues gameplay without state loss
- Restart produces a clean run (score=0, coins=0, empty bucket)
- All physics freezes when paused (get_tree().paused = true)
- PauseMenu buttons respond while game is paused (process_mode = ALWAYS)
- No UI element blocks game input when pause menu is hidden
- Touch input works for positioning and dropping (emulate_mouse_from_touch)
</verification>

<success_criteria>
Player can pause (Escape or button), resume, restart, and quit mid-run. Touch input works for positioning and dropping fruits. All buttons are touch-friendly (minimum 48dp hit area on 1080x1920 viewport).
</success_criteria>

<output>
After completion, create `.planning/phases/04-game-flow-input/04-01-SUMMARY.md`
</output>
