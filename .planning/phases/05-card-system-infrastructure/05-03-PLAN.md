---
phase: 05-card-system-infrastructure
plan: 03
type: execute
wave: 3
depends_on: ["05-02"]
files_modified:
  - scenes/ui/starter_pick.tscn
  - scenes/ui/starter_pick.gd
  - scenes/game/game.tscn
  - scenes/game/game.gd
autonomous: false

must_haves:
  truths:
    - "At run start, a card pick overlay appears before gameplay begins"
    - "Player sees 3 random card offers and picks 1 for free"
    - "Picked card immediately appears in HUD card slot"
    - "After picking, gameplay begins (DROPPING state)"
    - "Restarting the game resets all cards, coins, and shop level, then shows starter pick again"
    - "All 4 score thresholds open shops correctly across a full run"
  artifacts:
    - path: "scenes/ui/starter_pick.tscn"
      provides: "Starter card pick CanvasLayer overlay"
      contains: "CanvasLayer"
    - path: "scenes/ui/starter_pick.gd"
      provides: "Pick-one-of-three logic, emits starter_pick_completed"
      contains: "func _on_card_picked"
    - path: "scenes/game/game.tscn"
      provides: "Game scene with StarterPick node"
      contains: "StarterPick"
    - path: "scenes/game/game.gd"
      provides: "PICKING state before DROPPING, full card lifecycle flow"
      contains: "starter_pick_completed"
  key_links:
    - from: "scenes/game/game.gd"
      to: "scripts/autoloads/card_manager.gd"
      via: "generate_starter_offers() at run start"
      pattern: "CardManager\\.generate_starter_offers"
    - from: "scenes/ui/starter_pick.gd"
      to: "scripts/autoloads/event_bus.gd"
      via: "starter_pick_completed signal on pick"
      pattern: "EventBus\\.starter_pick_completed\\.emit"
    - from: "scenes/game/game.gd"
      to: "scripts/autoloads/game_manager.gd"
      via: "PICKING -> DROPPING state transition after pick"
      pattern: "GameState\\.DROPPING"
---

<objective>
Build the starter card pick overlay and complete the full card lifecycle: pick a free starter card -> play -> shop at thresholds -> restart resets everything. Verify the entire card system works end-to-end across a full run with restart.

Purpose: This completes the card lifecycle (CARD-05, CARD-10) and verifies the entire Phase 5 system works together. The starter pick introduces the card system immediately at run start, and the reset flow ensures per-run economy.

Output: Starter pick overlay scene, modified game flow (PICKING before DROPPING), verified full card lifecycle with reset.
</objective>

<execution_context>
@/home/zycroft/.claude/get-shit-done/workflows/execute-plan.md
@/home/zycroft/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/05-card-system-infrastructure/05-RESEARCH.md
@.planning/phases/05-card-system-infrastructure/05-01-SUMMARY.md
@.planning/phases/05-card-system-infrastructure/05-02-SUMMARY.md

@scenes/ui/card_shop.tscn
@scenes/ui/card_shop.gd
@scenes/ui/card_slot_display.tscn
@scenes/ui/card_slot_display.gd
@scenes/ui/hud.gd
@scenes/game/game.tscn
@scenes/game/game.gd
@scripts/autoloads/event_bus.gd
@scripts/autoloads/game_manager.gd
@scripts/autoloads/card_manager.gd
</context>

<tasks>

<task type="auto">
  <name>Task 1: Starter card pick overlay and game flow integration</name>
  <files>
    scenes/ui/starter_pick.tscn
    scenes/ui/starter_pick.gd
    scenes/game/game.tscn
    scenes/game/game.gd
  </files>
  <action>
    **StarterPick scene** (`scenes/ui/starter_pick.tscn`):
    - Root: CanvasLayer named "StarterPick", layer = 11 (same as shop), process_mode = 3 (ALWAYS).
    - Start visible = false.
    - Child structure mirroring CardShop but simpler (no sell, no coin cost):
      ```
      StarterPick (CanvasLayer, layer=11, process_mode=ALWAYS)
        Overlay (ColorRect, anchors_preset=15 full rect, color=Color(0,0,0,0.7), mouse_filter=0 STOP)
          PickContainer (VBoxContainer, centered)
            - anchors_preset=8 (center), offset_left=-300, offset_top=-350, offset_right=300, offset_bottom=350
            - mouse_filter=2 (IGNORE)
            - theme_override_constants/separation = 20
            TitleLabel (Label, "Choose a Starting Card", font_size=40, center aligned, mouse_filter=2)
            SubtitleLabel (Label, "Pick 1 card to begin your run", font_size=20, center aligned, mouse_filter=2, font_color=Color(0.8, 0.8, 0.8))
            OffersContainer (VBoxContainer, separation=16, mouse_filter=2)
              -- 3 CardSlotDisplay instances with "Pick" buttons, populated dynamically
      ```
    - Slightly darker overlay (0.7 alpha) than shop (0.6) because this is the very first screen the player sees.

    **StarterPick script** (`scenes/ui/starter_pick.gd`):
    - `extends CanvasLayer`
    - Preload: `var _card_slot_scene: PackedScene = preload("res://scenes/ui/card_slot_display.tscn")`
    - `_ready()`:
      - `process_mode = Node.PROCESS_MODE_ALWAYS`
      - `visible = false`
      - Connect `EventBus.starter_pick_requested.connect(_on_starter_pick_requested)`
    - `_on_starter_pick_requested(offers: Array)`:
      - Clear any existing children in OffersContainer (safety for restart).
      - For each card in offers:
        - Create an HBoxContainer with mouse_filter=IGNORE.
        - Instance a CardSlotDisplay, call display_card(card) (no price -- it's free).
        - Create a Button "Pick" (custom_minimum_size Vector2(100, 50), font_size=20).
        - Connect button pressed to `_on_card_picked.bind(card)`.
        - Add slot and button to HBoxContainer, add HBoxContainer to OffersContainer.
      - `visible = true`
    - `_on_card_picked(card: CardData)`:
      - Add to inventory: `CardManager.add_card(card, 0)` (purchase_price = 0, it's free).
      - Emit: `EventBus.starter_pick_completed.emit(card)`
      - Emit: `EventBus.active_cards_changed.emit(CardManager.active_cards)`
      - Clean up OffersContainer children (queue_free each).
      - `visible = false`

    **Game scene modifications** (`scenes/game/game.tscn`):
    - Add StarterPick as a child of Game node: instance of `res://scenes/ui/starter_pick.tscn`.
    - Place it after CardShop in the tree.

    **Game script modifications** (`scenes/game/game.gd`):
    - Modify `_ready()` to show starter pick instead of going directly to DROPPING:
      ```gdscript
      func _ready() -> void:
          GameManager.change_state(GameManager.GameState.READY)
          EventBus.game_over_triggered.connect(_on_game_over)
          EventBus.score_threshold_reached.connect(_on_score_threshold)
          EventBus.shop_closed.connect(_on_shop_closed)
          EventBus.starter_pick_completed.connect(_on_starter_pick_done)

          # Brief delay to let physics settle, then show starter card pick.
          await get_tree().create_timer(0.3).timeout
          _show_starter_pick()
      ```
    - Add `_show_starter_pick()`:
      ```gdscript
      func _show_starter_pick() -> void:
          var offers: Array = CardManager.generate_starter_offers(3)
          GameManager.change_state(GameManager.GameState.PICKING)
          EventBus.starter_pick_requested.emit(offers)
      ```
    - Add `_on_starter_pick_done(_card: CardData)`:
      ```gdscript
      func _on_starter_pick_done(_card: CardData) -> void:
          GameManager.change_state(GameManager.GameState.DROPPING)
      ```
    - Existing `_on_score_threshold()` and `_on_shop_closed()` from Plan 02 remain unchanged.
    - Existing `_on_game_over()` remains unchanged.
    - The key change: remove the direct `GameManager.change_state(GameManager.GameState.DROPPING)` after the 0.3s timer. Replace with `_show_starter_pick()`. The DROPPING transition now happens only after the player picks a card.
  </action>
  <verify>
    - `scenes/ui/starter_pick.tscn` exists with CanvasLayer root, layer 11, process_mode ALWAYS.
    - `scenes/ui/starter_pick.gd` has _on_starter_pick_requested and _on_card_picked functions.
    - `scenes/game/game.tscn` has StarterPick instance as child of Game.
    - `scenes/game/game.gd` shows starter pick before DROPPING state.
    - Game launches: starter pick overlay appears before gameplay.
    - Picking a card adds it to HUD slot and starts gameplay.
    - No fruit drops are possible before picking a card (tree is paused in PICKING state).
  </verify>
  <done>
    Starter pick overlay appears at run start showing 3 random cards (biased toward Common). Player picks one for free, it appears in HUD slot 0, and gameplay begins. PICKING state pauses the tree so no drops happen before selection. The flow is: READY -> PICKING (tree paused, pick overlay) -> pick card -> DROPPING (tree unpaused, gameplay begins).
  </done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <name>Task 2: Full card lifecycle playtest</name>
  <files>none</files>
  <action>
    Human playtest of the complete card system infrastructure: starter card pick at run start, 3 HUD card slots, coin economy, card shop at score thresholds (500, 1500, 3500, 7000), buy/sell/skip, rarity-weighted offers with price inflation, and per-run reset on restart.
  </action>
  <verify>
    1. Launch the game (F5 in Godot or via web export).
    2. **Starter pick**: A "Choose a Starting Card" overlay should appear before gameplay. You should see 3 cards with names, descriptions, and rarity-colored borders (grey=Common, green=Uncommon, gold=Rare). Most should be Common (shop level 0 weights).
    3. **Pick a card**: Click "Pick" on any card. It should appear in the bottom-left HUD card slot. The overlay closes and gameplay begins.
    4. **Play and earn coins**: Drop and merge fruits. Watch the coin counter increase (1 coin per 100 score). HUD card slot should remain visible at the bottom.
    5. **First shop (score 500)**: When score crosses 500, the game should pause and a "CARD SHOP" overlay appears. It should show:
       - Your current coins
       - 3 card offers with rarity borders and prices (base_price * 1.0x for first shop)
       - Your owned cards (the starter card) with a sell price
       - A "Continue" button
    6. **Buy a card**: If you have enough coins, click "Buy" on a card. It should deduct coins and appear in an empty HUD slot. The buy button should grey out.
    7. **Sell a card**: Click on one of your owned cards in the shop. It should be removed, and you receive 50% of the purchase price back (0 for the free starter card).
    8. **Skip**: Click "Continue" to close the shop and resume gameplay.
    9. **Second shop (score 1500)**: Prices should be higher (1.25x multiplier). You may see more uncommon cards.
    10. **Restart**: Pause (Esc or || button) and click Restart. The game should reset: no cards in HUD slots, coins back to 0, and the starter pick overlay appears again.
    11. **Verify clean reset**: After restart, the starter pick should show fresh random cards. Previous run's cards should be completely gone.
  </verify>
  <done>Human confirms the full card lifecycle works: pick -> play -> shop -> play -> restart -> pick. All card operations (buy/sell/skip/reset) function correctly. UI displays are accurate.</done>
</task>

</tasks>

<verification>
- Starter pick appears at run start with 3 card options
- Picking a card adds it to HUD and starts gameplay
- Score threshold at 500 opens shop with correct offers and prices
- Buy/sell/skip all function correctly in the shop
- Later shops (1500, 3500, 7000) have higher prices and more rare cards
- HUD card slots accurately reflect current inventory at all times
- Restart clears all cards, coins, shop level, and shows starter pick again
- No input leaks during PICKING or SHOPPING states (tree paused, overlays block clicks)
- Game over does not break card state (cards remain in slots)
</verification>

<success_criteria>
- Complete card lifecycle: pick -> play -> shop -> play -> shop -> game over -> restart -> pick
- Per-run economy resets completely (CARD-10)
- Starter card pick works with 3 options, 1 free pick (CARD-05)
- All 4 score thresholds trigger shops (CARD-02)
- Buy/sell/skip functional (CARD-03, CARD-07)
- Rarity and price scaling work (CARD-06, CARD-11)
- Card descriptions visible and clear (CARD-08)
- 3 HUD card slots display active cards (CARD-01)
- Coin economy functional and displayed (CARD-04)
- Human playtest confirms the full lifecycle feels correct
</success_criteria>

<output>
After completion, create `.planning/phases/05-card-system-infrastructure/05-03-SUMMARY.md`
</output>
