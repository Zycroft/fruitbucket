---
phase: 06-card-effects-physics-merge
plan: 02
type: execute
wave: 2
depends_on: ["06-01"]
files_modified:
  - scripts/components/card_effect_system.gd
  - scripts/components/merge_manager.gd
  - scripts/components/drop_controller.gd
  - scenes/ui/card_slot_display.gd
  - scenes/ui/hud.gd
autonomous: true

must_haves:
  truths:
    - "Heavy Hitter gives next 3 dropped fruits 2x mass, pushing harder on contact"
    - "Heavy Hitter charge count is visible on the HUD card slot (e.g., '3/3') and decrements per drop"
    - "Heavy Hitter preview fruit looks different (darker tint) when a heavy charge will apply"
    - "Heavy Hitter recharges to 3/3 after 5 merges once charges are depleted"
    - "Wild Fruit periodically designates a random on-screen fruit as wild (rainbow shimmer)"
    - "Wild fruit merges with same-tier OR adjacent-tier fruits on contact"
    - "Wild merge result upgrades to max(tier_a, tier_b) + 1 (generous upgrade)"
    - "Both Heavy Hitter and Wild Fruit effects reset cleanly on game restart"
  artifacts:
    - path: "scripts/components/card_effect_system.gd"
      provides: "Heavy Hitter charge system and Wild Fruit periodic selection"
      contains: "_heavy_charges"
    - path: "scripts/components/merge_manager.gd"
      provides: "Wild merge result calculation (max tier + 1)"
      contains: "is_wild"
    - path: "scripts/components/drop_controller.gd"
      provides: "Heavy Hitter preview fruit visual distinction"
      contains: "is_heavy"
    - path: "scenes/ui/card_slot_display.gd"
      provides: "Status text overlay for charge display"
      contains: "set_status_text"
    - path: "scenes/ui/hud.gd"
      provides: "Heavy Hitter charge display on HUD card slots"
      contains: "heavy_hitter_charges_changed"
  key_links:
    - from: "scripts/components/card_effect_system.gd"
      to: "EventBus.fruit_dropped"
      via: "Heavy Hitter charge consumption on drop"
      pattern: "fruit_dropped\\.connect"
    - from: "scripts/components/card_effect_system.gd"
      to: "EventBus.heavy_hitter_charges_changed"
      via: "Emits charge state changes for HUD"
      pattern: "heavy_hitter_charges_changed\\.emit"
    - from: "scripts/components/merge_manager.gd"
      to: "fruit.is_wild"
      via: "Wild merge result calculation checks is_wild flag"
      pattern: "is_wild"
    - from: "scenes/ui/hud.gd"
      to: "EventBus.heavy_hitter_charges_changed"
      via: "HUD listens and updates card slot status text"
      pattern: "heavy_hitter_charges_changed\\.connect"
---

<objective>
Implement Heavy Hitter (charge-based mass boost) and Wild Fruit (periodic wild designation with rainbow shader and adjacent-tier merging). These are the two "stateful" effects requiring persistent tracking (charges, wild fruit references, merge counters) and deeper integration with the drop pipeline and merge system.

Purpose: Completes all 4 Phase 6 card effects, demonstrating the full range of physics/merge modification -- property changes (bounce, mass), rule extensions (wild merge), and event reactions (blast, recharge).
Output: Heavy Hitter with visible charges and recharge cycle, Wild Fruit with rainbow shimmer and adjacent-tier merging.
</objective>

<execution_context>
@/home/zycroft/.claude/get-shit-done/workflows/execute-plan.md
@/home/zycroft/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/06-card-effects-physics-merge/06-CONTEXT.md
@.planning/phases/06-card-effects-physics-merge/06-RESEARCH.md
@.planning/phases/06-card-effects-physics-merge/06-01-SUMMARY.md
@scripts/components/card_effect_system.gd
@scripts/components/merge_manager.gd
@scripts/components/drop_controller.gd
@scenes/fruit/fruit.gd
@scenes/ui/card_slot_display.gd
@scenes/ui/hud.gd
@scripts/autoloads/event_bus.gd
</context>

<tasks>

<task type="auto">
  <name>Task 1: Heavy Hitter charge system with drop-time mass boost and HUD integration</name>
  <files>
    scripts/components/card_effect_system.gd
    scripts/components/drop_controller.gd
    scenes/ui/card_slot_display.gd
    scenes/ui/hud.gd
  </files>
  <action>
Implement the Heavy Hitter card effect with a reusable charge/recharge system.

**1. CardEffectSystem -- Heavy Hitter state and logic:**

Add constants:
- `const HEAVY_CHARGES_MAX: int = 3`
- `const HEAVY_RECHARGE_MERGES: int = 5`
- `const HEAVY_MASS_MULTIPLIER: float = 2.0` (double mass per stack)

Add state variables:
- `var _heavy_charges: int = 0` (current charges)
- `var _heavy_recharging: bool = false` (true when charges are depleted and counting merges)
- `var _heavy_merge_counter: int = 0` (merges counted toward recharge)

On `_ready()` or whenever heavy hitter becomes active: if `_count_active("heavy_hitter") > 0`, initialize charges to `HEAVY_CHARGES_MAX`. Emit `EventBus.heavy_hitter_charges_changed.emit(_heavy_charges, HEAVY_CHARGES_MAX)`.

In `_on_card_changed()` (card_purchased signal): if the purchased card is "heavy_hitter", reset charges:
- `_heavy_charges = HEAVY_CHARGES_MAX`
- `_heavy_recharging = false`
- `_heavy_merge_counter = 0`
- Emit `EventBus.heavy_hitter_charges_changed.emit(_heavy_charges, HEAVY_CHARGES_MAX)`

In `_on_card_removed()` (card_sold signal): if a "heavy_hitter" card was sold and `_count_active("heavy_hitter") == 0`:
- Reset all heavy hitter state to 0
- Emit `EventBus.heavy_hitter_charges_changed.emit(0, 0)` to hide charge display

In `_on_fruit_dropped(tier: int, pos: Vector2)`:
- If `_count_active("heavy_hitter") > 0 and _heavy_charges > 0`:
  - `_heavy_charges -= 1`
  - Find the just-dropped fruit: iterate FruitContainer children, find the Fruit at `pos` (or the one most recently added -- use `container.get_child(container.get_child_count() - 1)` since the drop just happened, but verify it is a Fruit at the expected position). Alternatively, since `fruit_dropped` fires immediately after the fruit is unfrozen, the last child of FruitContainer whose `global_position` is closest to `pos` is the target.
  - Apply mass boost: `fruit.mass = fruit.fruit_data.mass_override * HEAVY_MASS_MULTIPLIER * _count_active("heavy_hitter")`
  - Set `fruit.is_heavy = true`
  - Visual: darken the sprite -- `fruit.get_node("Sprite2D").modulate = fruit.fruit_data.color.darkened(0.3)`
  - Emit: `EventBus.heavy_hitter_charges_changed.emit(_heavy_charges, HEAVY_CHARGES_MAX)`
  - If `_heavy_charges <= 0`: set `_heavy_recharging = true`, `_heavy_merge_counter = 0`

In `_on_fruit_merged()` -- recharge logic (add to existing method):
- If `_count_active("heavy_hitter") > 0 and _heavy_recharging`:
  - `_heavy_merge_counter += 1`
  - If `_heavy_merge_counter >= HEAVY_RECHARGE_MERGES`:
    - `_heavy_charges = HEAVY_CHARGES_MAX`
    - `_heavy_recharging = false`
    - `_heavy_merge_counter = 0`
    - Emit: `EventBus.heavy_hitter_charges_changed.emit(_heavy_charges, HEAVY_CHARGES_MAX)`

**2. DropController -- Heavy Hitter preview visual:**

In `drop_controller.gd`, modify `_spawn_preview()`:
- After spawning the preview fruit (`_current_fruit = _merge_manager.spawn_fruit(...)`):
- Check if Heavy Hitter is active and has charges: query CardEffectSystem via group lookup or check CardManager directly:
  ```gdscript
  var effect_system = get_tree().get_first_node_in_group("card_effect_system")
  if effect_system and effect_system.has_heavy_charges():
      _current_fruit.is_heavy = true
      _current_fruit.get_node("Sprite2D").modulate = _current_fruit.fruit_data.color.darkened(0.3)
  ```
- Add a public method to CardEffectSystem: `func has_heavy_charges() -> bool: return _count_active("heavy_hitter") > 0 and _heavy_charges > 0`

Also update preview when charges change: connect `EventBus.heavy_hitter_charges_changed` in DropController._ready(). When charges change and there is a current preview fruit, update its visual:
- If charges > 0 and heavy_hitter active: darken the preview
- If charges == 0: restore normal color on preview

**3. CardSlotDisplay -- Status text:**

Add a method `set_status_text(text: String) -> void` to card_slot_display.gd:
- Show a small label overlay on the card slot. If PriceLabel exists and is not used for price display, repurpose it. Otherwise, create a simple approach:
  - If `text.is_empty()`: hide the status. Set `$MarginContainer/Content/PriceLabel.visible = false`.
  - If not empty: show it. Set `$MarginContainer/Content/PriceLabel.visible = true`, `$MarginContainer/Content/PriceLabel.text = text`.
- Note: PriceLabel is already part of the card slot. In HUD mode (no sell/buy), it is hidden. Reuse it for charge display. This avoids creating new UI nodes.

Add a method `clear_status_text() -> void`:
- `$MarginContainer/Content/PriceLabel.visible = false`

**4. HUD -- Heavy Hitter charge display:**

In hud.gd `_ready()`, connect: `EventBus.heavy_hitter_charges_changed.connect(_on_heavy_hitter_charges_changed)`

Add method `_on_heavy_hitter_charges_changed(charges: int, max_charges: int) -> void`:
- Find which HUD card slot has the Heavy Hitter card. Iterate `_card_slot_nodes` and check `CardManager.get_card(i)` -- if `card.card_id == "heavy_hitter"`, update that slot.
- If `max_charges > 0`: call `slot.set_status_text("%d/%d" % [charges, max_charges])` on the matching slot.
- If `max_charges == 0` (card removed): call `slot.clear_status_text()` on all slots (cleanup).
  </action>
  <verify>
Run the game. Test:
1. Pick Heavy Hitter as starter card. HUD slot shows "3/3" charge display.
2. Drop 3 fruits -- each drop decrements charge (3/3 -> 2/3 -> 1/3 -> 0/3). Dropped fruits appear darker and push existing fruits harder on landing.
3. After 0/3, perform 5 merges -- charges refill to 3/3.
4. Preview fruit appears darker when charges are available, normal when depleted.
5. Sell Heavy Hitter -- charge display disappears, drops return to normal mass.
6. Restart -- charges reset to full, no stale state.
  </verify>
  <done>
Heavy Hitter consumes 1 charge per drop (3 max), doubles mass for dropped fruit, darkens preview and dropped fruit, recharges to 3/3 after 5 merges. HUD card slot shows charge count. DropController shows heavy preview visual. Clean reset on restart.
  </done>
</task>

<task type="auto">
  <name>Task 2: Wild Fruit periodic selection with rainbow shader and adjacent-tier merge logic</name>
  <files>
    scripts/components/card_effect_system.gd
    scripts/components/merge_manager.gd
  </files>
  <action>
Implement the Wild Fruit card effect with periodic selection, rainbow shader marking, and merge rule extension in MergeManager.

**1. CardEffectSystem -- Wild Fruit state and logic:**

Add constants:
- `const WILD_SELECT_INTERVAL: int = 5` (select a new wild fruit every 5 merges)
- `const WILD_MAX_PER_CARD: int = 1` (1 wild fruit per Wild Fruit card owned)

Add state variables:
- `var _wild_fruits: Array = []` (references to currently wild Fruit instances)
- `var _wild_merge_counter: int = 0` (merges since last wild selection)

Preload the rainbow shader: `var _rainbow_shader: Shader = preload("res://resources/shaders/rainbow_outline.gdshader")`

Method `_mark_fruit_as_wild(fruit: Fruit) -> void`:
- Set `fruit.is_wild = true`
- Create `ShaderMaterial.new()`, set shader to `_rainbow_shader`
- Set shader parameters: `line_scale = 4.0`, `frequency = 0.8`, `light_offset = 0.5`
- Apply to `fruit.get_node("Sprite2D").material = mat`
- Add to `_wild_fruits` array
- Emit: `EventBus.wild_fruit_marked.emit(fruit)`

Method `_unmark_fruit_as_wild(fruit: Fruit) -> void`:
- Set `fruit.is_wild = false`
- Reset: `fruit.get_node("Sprite2D").material = null`
- Remove from `_wild_fruits` array
- Emit: `EventBus.wild_fruit_unmarked.emit(fruit)`

Method `_select_wild_fruits() -> void`:
- Calculate `max_wild: int = _count_active("wild_fruit") * WILD_MAX_PER_CARD`
- Clean up invalid references: remove entries from `_wild_fruits` where `not is_instance_valid(fruit)` or fruit no longer exists in tree
- If `_wild_fruits.size() >= max_wild`: return (already at capacity)
- Get all valid non-wild, non-merging, non-dropping, non-frozen Fruit children from FruitContainer
- If no candidates: return
- Pick random candidate(s) until at capacity or no more candidates
- Call `_mark_fruit_as_wild(candidate)` for each

In `_on_fruit_merged()` -- wild fruit logic:
- Clean up: if any fruit in `_wild_fruits` is no longer valid (merged or freed), remove it
- Increment `_wild_merge_counter`
- If `_count_active("wild_fruit") > 0 and _wild_merge_counter >= WILD_SELECT_INTERVAL`:
  - `_wild_merge_counter = 0`
  - Call `_select_wild_fruits()`

In `_on_card_changed()`: if purchased card is "wild_fruit":
- `_wild_merge_counter = 0`
- Call `_select_wild_fruits()` immediately (retroactive -- select from existing fruits)

In `_on_card_removed()`: if sold card is "wild_fruit" and `_count_active("wild_fruit") == 0`:
- Unmark all wild fruits: iterate `_wild_fruits` copy, call `_unmark_fruit_as_wild(fruit)` for each valid one
- Clear `_wild_fruits`, reset `_wild_merge_counter = 0`
- If still some wild_fruit cards remain but fewer, trim excess wild fruits down to new max

**2. MergeManager -- Wild merge result calculation:**

Modify `request_merge()` in merge_manager.gd. The current logic:
```gdscript
var old_tier: int = fruit_a.fruit_data.tier
var new_tier: int = old_tier + 1
```

Replace with:
```gdscript
var tier_a: int = fruit_a.fruit_data.tier
var tier_b: int = fruit_b.fruit_data.tier
var is_wild_merge: bool = fruit_a.is_wild or fruit_b.is_wild
var old_tier: int  # For the EventBus signal (tier of consumed pair)
var new_tier: int

if is_wild_merge and tier_a != tier_b:
    # Wild merge with adjacent tier: result is max(tier_a, tier_b) + 1 (generous upgrade)
    old_tier = maxi(tier_a, tier_b)
    new_tier = old_tier + 1
else:
    # Standard merge: both fruits are same tier
    old_tier = tier_a
    new_tier = old_tier + 1
```

This change is backward-compatible: when both fruits are the same tier (standard merge), the logic is identical to before. Only wild merges with different tiers use the max+1 calculation.

IMPORTANT: The `old_tier` in the EventBus signal should use `maxi(tier_a, tier_b)` for wild merges so that downstream systems (ScoreManager, MergeFeedback) score based on the higher tier. This is the "generous, rewarding" behavior from CONTEXT.

Also note: The merge check already passes thanks to `_can_merge_with()` added in Plan 01. MergeManager does not need to check tier matching -- fruit.gd handles that before calling `request_merge()`.

**3. Cleanup on card removal -- full Wild Fruit cleanup method:**

Method `_cleanup_wild_fruits() -> void`:
- For each fruit in `_wild_fruits` (iterate a copy since we modify the array):
  - If `is_instance_valid(fruit)`: call `_unmark_fruit_as_wild(fruit)`
- `_wild_fruits.clear()`
- `_wild_merge_counter = 0`
  </action>
  <verify>
Run the game. Test:
1. Pick Wild Fruit as starter card. After ~5 merges, one fruit in the bucket should gain a rainbow shimmer outline.
2. Drop a fruit adjacent to the wild fruit's tier (e.g., wild tier-2 cherry next to a tier-3 strawberry) -- they should merge, producing a tier-4 orange (max(2,3)+1=4).
3. After the wild fruit merges, after another ~5 merges a new wild fruit should be designated.
4. Sell Wild Fruit card -- all rainbow shimmer should disappear. Fruits stop merging with adjacent tiers.
5. Buy 2 Wild Fruit cards -- 2 fruits should become wild simultaneously.
6. Verify normal same-tier merges still work as before (no regression).
7. Restart -- no wild fruits persist from previous run.
  </verify>
  <done>
Wild Fruit periodically designates random on-screen fruits as wild (rainbow shimmer via shader). Wild fruits merge with same-tier OR adjacent-tier fruits. Wild merge result upgrades to max(tier_a, tier_b)+1. 1 wild fruit per card owned. Reselection every 5 merges. Clean removal on card sell. No regression on standard merges.
  </done>
</task>

</tasks>

<verification>
1. All 4 card effects functional: Bouncy Berry (bounce boost), Heavy Hitter (mass boost with charges), Wild Fruit (rainbow shimmer + adjacent merge), Cherry Bomb (blast + shockwave)
2. Duplicate cards stack linearly for all effects
3. Buying a card applies effects retroactively where specified (Bouncy Berry, Wild Fruit)
4. Selling a card removes effects cleanly
5. Game restart resets all effect state
6. No regression on standard same-tier merging
7. No crashes on edge cases: watermelon vanish, empty bucket blast, no valid wild candidates
</verification>

<success_criteria>
- Heavy Hitter gives next 3 drops 2x mass with visible charge counter on HUD slot (N/3)
- Heavy Hitter recharges to 3/3 after 5 merges once depleted
- Heavy Hitter preview fruit is visually distinct (darker tint) when charges available
- Wild Fruit designates 1 random fruit per card with rainbow shimmer outline
- Wild fruit merges with adjacent tiers, result = max(tier_a, tier_b) + 1
- Wild fruit selection triggers every 5 merges
- All effects reset cleanly on game restart with no state leakage
- No GDScript parse errors, no runtime crashes
</success_criteria>

<output>
After completion, create `.planning/phases/06-card-effects-physics-merge/06-02-SUMMARY.md`
</output>
