---
phase: 07-card-effects-scoring-economy
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - scripts/components/score_manager.gd
  - scripts/autoloads/event_bus.gd
  - scripts/components/card_effect_system.gd
  - scenes/ui/floating_score.gd
  - scenes/ui/hud.gd
autonomous: true

must_haves:
  truths:
    - "Quick Fuse awards +25% bonus score per card when merge happens during an active chain (chain_count >= 2)"
    - "Fruit Frenzy awards +2x base_score bonus per card when chain_count >= 3"
    - "Big Game Hunter awards +50% bonus score per card when the created fruit is tier 7+ (code tier >= 6)"
    - "Bonus score popups appear at the merge position in a distinct color (purple) separate from normal score popups"
    - "HUD score counter updates to include card bonus score"
  artifacts:
    - path: "scripts/components/score_manager.gd"
      provides: "Public get_chain_count() accessor for chain state"
      contains: "func get_chain_count"
    - path: "scripts/autoloads/event_bus.gd"
      provides: "bonus_awarded signal for card-sourced bonus feedback"
      contains: "signal bonus_awarded"
    - path: "scripts/components/card_effect_system.gd"
      provides: "FruitData loading, _apply_quick_fuse, _apply_fruit_frenzy, _apply_big_game_hunter, _get_base_score, _apply_scoring_effects dispatcher"
      contains: "_apply_scoring_effects"
    - path: "scenes/ui/floating_score.gd"
      provides: "show_bonus method with color parameter for card bonus popups"
      contains: "func show_bonus"
    - path: "scenes/ui/hud.gd"
      provides: "bonus_awarded signal handler that spawns colored bonus popups"
      contains: "_on_bonus_awarded"
  key_links:
    - from: "scripts/components/card_effect_system.gd"
      to: "scripts/components/score_manager.gd"
      via: "get_chain_count() accessor for Quick Fuse and Fruit Frenzy conditions"
      pattern: "sm\\.get_chain_count\\(\\)"
    - from: "scripts/components/card_effect_system.gd"
      to: "scripts/autoloads/event_bus.gd"
      via: "EventBus.bonus_awarded.emit() for bonus popup feedback"
      pattern: "EventBus\\.bonus_awarded\\.emit"
    - from: "scenes/ui/hud.gd"
      to: "scripts/autoloads/event_bus.gd"
      via: "EventBus.bonus_awarded.connect(_on_bonus_awarded) for popup spawning"
      pattern: "EventBus\\.bonus_awarded\\.connect"
---

<objective>
Implement scoring infrastructure and three score-bonus card effects (Quick Fuse, Fruit Frenzy, Big Game Hunter) that award bonus points during merges based on chain state and fruit tier.

Purpose: Establishes the scoring effects pipeline -- ScoreManager accessor, EventBus signal, FruitData lookup, bonus popup visuals -- and implements the three effects that modify score awards. This infrastructure is reused by Plan 02 for coin/mixed effects.

Output: Three working score-bonus card effects with visible purple floating popups at merge positions, all applying bonuses to GameManager.score independently of ScoreManager.
</objective>

<execution_context>
@/home/zycroft/.claude/get-shit-done/workflows/execute-plan.md
@/home/zycroft/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/07-card-effects-scoring-economy/07-RESEARCH.md
@scripts/components/card_effect_system.gd
@scripts/components/score_manager.gd
@scripts/autoloads/event_bus.gd
@scenes/ui/floating_score.gd
@scenes/ui/hud.gd
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add scoring infrastructure and three score-bonus effect methods</name>
  <files>
    scripts/components/score_manager.gd
    scripts/autoloads/event_bus.gd
    scripts/components/card_effect_system.gd
  </files>
  <action>
**score_manager.gd** -- Add a public read-only accessor for chain state. Add these two methods anywhere after `_on_chain_expired()`:

```gdscript
func get_chain_count() -> int:
    ## Public read-only accessor for current chain count.
    ## Used by CardEffectSystem for Quick Fuse and Fruit Frenzy.
    return _chain_count
```

**event_bus.gd** -- Add a new signal for card-sourced bonus feedback. Add after the `cherry_bomb_triggered` signal:

```gdscript
## Emitted when a card effect awards bonus score or coins (for bonus popups).
signal bonus_awarded(amount: int, position: Vector2, bonus_type: String)
```

`bonus_type` is "score" or "coins" -- the HUD uses this for popup color selection.

**card_effect_system.gd** -- Add FruitData loading, base_score lookup, three effect methods, and the scoring dispatcher. Specific changes:

1. Add constants after the Wild Fruit constants block:
```gdscript
# --- Scoring effect constants ---
## Quick Fuse: +25% of base_score per card for merges during active chain.
const QUICK_FUSE_BONUS: float = 0.25
## Fruit Frenzy: bonus = base_score * 2.0 * card_count for chains of 3+.
const FRUIT_FRENZY_MULTIPLIER: float = 2.0
const FRUIT_FRENZY_MIN_CHAIN: int = 3
## Big Game Hunter: +50% of base_score per card for tier 7+ (code tier >= 6) merges.
const BIG_GAME_BONUS: float = 0.5
const BIG_GAME_MIN_TIER: int = 6
```

2. Add a `_fruit_types` variable after `_rainbow_shader`:
```gdscript
## FruitData resources for base score lookup (loaded in _ready).
var _fruit_types: Array[FruitData] = []
```

3. In `_ready()`, call `_load_fruit_types()` before the EventBus signal connections.

4. Add `_load_fruit_types()` method (copy the same pattern from ScoreManager -- load all 8 .tres files into `_fruit_types` array).

5. Add `_get_base_score(new_tier: int) -> int` helper:
```gdscript
func _get_base_score(new_tier: int) -> int:
    ## Look up the base score_value for a given tier from FruitData.
    ## Returns WATERMELON_VANISH_BONUS for watermelon vanish (tier >= array size).
    if new_tier >= _fruit_types.size():
        return 1000  # Watermelon vanish bonus
    return _fruit_types[new_tier].score_value
```

6. Add the three score-bonus effect methods:
- `_apply_quick_fuse(new_tier: int) -> int`: Check `_count_active("quick_fuse")`. If 0, return 0. Get ScoreManager via `get_tree().get_first_node_in_group("score_manager")`. If ScoreManager is null or `sm.get_chain_count() < 2`, return 0 (first merge in chain does NOT qualify). Return `int(_get_base_score(new_tier) * QUICK_FUSE_BONUS * count)`.
- `_apply_fruit_frenzy(new_tier: int) -> int`: Check `_count_active("fruit_frenzy")`. If 0, return 0. Get ScoreManager. If `sm.get_chain_count() < FRUIT_FRENZY_MIN_CHAIN`, return 0. Return `int(_get_base_score(new_tier) * FRUIT_FRENZY_MULTIPLIER * count)`.
- `_apply_big_game_hunter(new_tier: int) -> int`: Check `_count_active("big_game_hunter")`. If 0, return 0. If `new_tier < BIG_GAME_MIN_TIER`, return 0. Return `int(_get_base_score(new_tier) * BIG_GAME_BONUS * count)`.

7. Add `_apply_scoring_effects(old_tier: int, new_tier: int, merge_pos: Vector2) -> void` dispatcher. This is a PARTIAL dispatcher for Plan 01 -- Plan 02 will add coin effects to it. For now:
```gdscript
func _apply_scoring_effects(_old_tier: int, new_tier: int, merge_pos: Vector2) -> void:
    ## Compute and apply all scoring/economy card bonuses for this merge.
    var bonus_score: int = 0

    bonus_score += _apply_quick_fuse(new_tier)
    bonus_score += _apply_fruit_frenzy(new_tier)
    bonus_score += _apply_big_game_hunter(new_tier)

    if bonus_score > 0:
        GameManager.score += bonus_score
        EventBus.bonus_awarded.emit(bonus_score, merge_pos, "score")
```

8. In `_on_fruit_merged()`, add a call to `_apply_scoring_effects(old_tier, _new_tier, merge_pos)` at the END of the method (after all existing Phase 6 dispatch). Change the `_new_tier` parameter name to `new_tier` (remove underscore prefix) since it is now used.

**Important design notes:**
- Percentage bonuses apply to `base_score` (FruitData.score_value) ONLY, not to the chain-multiplied total. This prevents runaway inflation.
- Fruit Frenzy "+2x" is interpreted as an additive bonus of `base_score * 2` per card, not multiplicative on the chain multiplier. This is the conservative interpretation from the planning context.
- Quick Fuse triggers for chain_count >= 2 (the merge IS part of a chain). The first merge in a chain (chain_count == 1) does NOT trigger Quick Fuse.
- Big Game Hunter triggers on `new_tier >= 6` (the CREATED tier is Pear or Watermelon).
  </action>
  <verify>
Open the project in Godot (or run `grep -n "get_chain_count\|bonus_awarded\|_apply_scoring_effects\|_apply_quick_fuse\|_apply_fruit_frenzy\|_apply_big_game_hunter\|_get_base_score\|_load_fruit_types" scripts/components/card_effect_system.gd scripts/components/score_manager.gd scripts/autoloads/event_bus.gd`). Confirm:
1. ScoreManager has `get_chain_count()` public method
2. EventBus has `bonus_awarded` signal with 3 parameters
3. CardEffectSystem has all 6 new methods, constants, and FruitData loading
4. `_on_fruit_merged` calls `_apply_scoring_effects` at the end
  </verify>
  <done>
ScoreManager exposes chain_count read-only. EventBus has bonus_awarded signal. CardEffectSystem loads FruitData, computes base_score, and dispatches Quick Fuse (+25%), Fruit Frenzy (+2x base), and Big Game Hunter (+50%) bonuses to GameManager.score with bonus_awarded signal emission.
  </done>
</task>

<task type="auto">
  <name>Task 2: Add colored bonus popups and HUD bonus wiring</name>
  <files>
    scenes/ui/floating_score.gd
    scenes/ui/hud.gd
  </files>
  <action>
**floating_score.gd** -- Add a `show_bonus()` method that displays bonus text with a custom color. Add after the existing `show_score()` method:

```gdscript
func show_bonus(text_value: String, start_pos: Vector2, bonus_type: String) -> void:
    ## Display a card bonus popup with distinct color styling.
    ## bonus_type: "score" = purple, "coins" = green.
    text = text_value
    # Offset slightly below normal score popups to avoid overlap.
    global_position = start_pos + Vector2(randf_range(-20.0, 20.0), 30.0)

    pivot_offset = size / 2.0

    if bonus_type == "coins":
        modulate = Color(0.2, 0.9, 0.3, 1.0)  # Green for coin bonuses
    else:
        modulate = Color(0.7, 0.4, 1.0, 1.0)  # Purple for score bonuses

    var tween: Tween = create_tween()
    tween.set_parallel(true)

    var duration: float = 1.2

    # Rise upward.
    tween.tween_property(self, "position:y", position.y - 80.0, duration) \
        .set_trans(Tween.TRANS_QUAD).set_ease(Tween.EASE_OUT)

    # Fade out.
    tween.tween_property(self, "modulate:a", 0.0, duration) \
        .set_trans(Tween.TRANS_QUAD).set_ease(Tween.EASE_IN)

    # Subtle scale punch for bonus popups.
    tween.tween_property(self, "scale", Vector2(1.3, 1.3), 0.12) \
        .set_trans(Tween.TRANS_BACK).set_ease(Tween.EASE_OUT)
    tween.chain().tween_property(self, "scale", Vector2(1.0, 1.0), 0.2)

    tween.chain().tween_callback(queue_free)
```

Key differences from `show_score()`:
- Y offset is +30 (below merge point) instead of 0 (at merge point), creating visual separation from normal score popups
- Rise distance is 80px instead of 100px (slightly shorter travel)
- Purple color for score bonuses, green for coin bonuses
- Moderate scale punch (1.3x) to distinguish from chain emphasis (1.8x)

**hud.gd** -- Connect to the new `bonus_awarded` signal and spawn colored bonus popups. Changes:

1. In `_ready()`, add after the existing EventBus connections:
```gdscript
EventBus.bonus_awarded.connect(_on_bonus_awarded)
```

2. Add the handler method:
```gdscript
func _on_bonus_awarded(amount: int, merge_pos: Vector2, bonus_type: String) -> void:
    ## Spawn a colored floating popup for card bonus awards.
    var popup_container: Node2D = get_tree().get_first_node_in_group("popup_container") as Node2D
    if not popup_container:
        return

    var popup: Label = _floating_score_scene.instantiate()
    popup_container.add_child(popup)

    var popup_text: String
    if bonus_type == "coins":
        popup_text = "+%d coins" % amount
    else:
        popup_text = "+%d" % amount
    popup.show_bonus(popup_text, merge_pos, bonus_type)

    # Also update score display if it was a score bonus (GameManager.score already updated).
    if bonus_type == "score":
        animate_score_to(GameManager.score)
```

The `animate_score_to()` call ensures the HUD score counter reflects the card bonus. ScoreManager's handler already called `animate_score_to()` for the base score, but the card bonus was added AFTER that. The tween-based animation handles being called again gracefully (it kills the previous tween and animates from current displayed value).
  </action>
  <verify>
Run `grep -n "show_bonus\|_on_bonus_awarded\|bonus_awarded" scenes/ui/floating_score.gd scenes/ui/hud.gd`. Confirm:
1. floating_score.gd has `show_bonus()` method with color parameter
2. hud.gd connects to `EventBus.bonus_awarded` in `_ready()`
3. hud.gd has `_on_bonus_awarded()` handler that spawns popup and updates score display
  </verify>
  <done>
Floating score popups support colored bonus display (purple for score, green for coins). HUD spawns bonus popups via bonus_awarded signal and updates the score counter for card bonus score. Normal score popups (white/gold) and card bonus popups (purple/green) are visually distinct with vertical offset separation.
  </done>
</task>

</tasks>

<verification>
1. Quick Fuse: Equip Quick Fuse card. Create a chain reaction (2+ merges within 1 second). Observe purple bonus popup appearing below the normal score popup showing +25% of base_score.
2. Fruit Frenzy: Equip Fruit Frenzy card. Create a chain of 3+ merges. Observe purple bonus popup showing +2x base_score bonus on the 3rd and subsequent merges.
3. Big Game Hunter: Equip Big Game Hunter card. Create a Pear or Watermelon via merging. Observe purple bonus popup showing +50% of base_score.
4. Visual distinction: Normal score popups appear white/gold at merge position. Card bonus popups appear purple, offset 30px below.
5. Score accuracy: HUD score counter reflects both base score (from ScoreManager) and card bonuses (from CardEffectSystem).
</verification>

<success_criteria>
- Three score-bonus card effects compute correct bonus amounts based on chain state and tier conditions
- Bonus score is added directly to GameManager.score independently of ScoreManager
- Purple bonus popups spawn at merge positions with visual separation from normal popups
- HUD score counter updates to reflect total score including card bonuses
- ScoreManager remains unchanged except for the public get_chain_count() accessor
</success_criteria>

<output>
After completion, create `.planning/phases/07-card-effects-scoring-economy/07-01-SUMMARY.md`
</output>
