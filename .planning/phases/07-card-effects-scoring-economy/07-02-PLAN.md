---
phase: 07-card-effects-scoring-economy
plan: 02
type: execute
wave: 2
depends_on: ["07-01"]
files_modified:
  - scripts/components/card_effect_system.gd
autonomous: true

must_haves:
  truths:
    - "Golden Touch awards +2 coins per card per merge, visibly increasing coin income"
    - "Lucky Break has a 15% independent chance per card to award +5 bonus coins on any merge"
    - "Pineapple Express awards +20 coins and +100 score when a Pear (code tier 6) is created from merging"
    - "Bonus coin popups appear in green at merge positions"
    - "HUD coin counter updates immediately when bonus coins are awarded"
  artifacts:
    - path: "scripts/components/card_effect_system.gd"
      provides: "Golden Touch, Lucky Break, Pineapple Express effect methods and completed _apply_scoring_effects dispatcher"
      contains: "_apply_golden_touch"
  key_links:
    - from: "scripts/components/card_effect_system.gd"
      to: "scripts/autoloads/event_bus.gd"
      via: "EventBus.coins_awarded.emit() for direct coin award HUD updates"
      pattern: "EventBus\\.coins_awarded\\.emit"
    - from: "scripts/components/card_effect_system.gd"
      to: "scripts/autoloads/event_bus.gd"
      via: "EventBus.bonus_awarded.emit() for green coin bonus popups"
      pattern: "EventBus\\.bonus_awarded\\.emit.*coins"
---

<objective>
Implement three coin/mixed card effects (Golden Touch, Lucky Break, Pineapple Express) and complete the scoring effects dispatcher to handle all six Phase 7 card effects.

Purpose: Completes the six scoring/economy card effects that give players strategic choices about score optimization versus coin accumulation. Golden Touch and Lucky Break provide consistent/probabilistic coin income, while Pineapple Express rewards creating a specific high-tier fruit with both coins and score.

Output: All six Phase 7 card effects operational with visible feedback -- the full _apply_scoring_effects dispatcher handles score bonuses (purple popups) and coin bonuses (green popups) on every merge.
</objective>

<execution_context>
@/home/zycroft/.claude/get-shit-done/workflows/execute-plan.md
@/home/zycroft/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/07-card-effects-scoring-economy/07-RESEARCH.md
@.planning/phases/07-card-effects-scoring-economy/07-01-SUMMARY.md
@scripts/components/card_effect_system.gd
@scripts/autoloads/event_bus.gd
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add Golden Touch, Lucky Break, and Pineapple Express effects</name>
  <files>scripts/components/card_effect_system.gd</files>
  <action>
Add three coin/mixed effect methods and their constants to CardEffectSystem, then update the `_apply_scoring_effects` dispatcher to include all six effects.

**1. Add constants** after the Big Game Hunter constants (added in Plan 01):

```gdscript
## Golden Touch: flat +2 coins per card per merge.
const GOLDEN_TOUCH_COINS: int = 2
## Lucky Break: 15% independent chance per card to award bonus coins.
const LUCKY_BREAK_CHANCE: float = 0.15
const LUCKY_BREAK_COINS: int = 5
## Pineapple Express: triggers when Pear (code tier 6) is created.
## Mapped from "pineapple" since no pineapple tier exists (per research recommendation).
const PINEAPPLE_TIER: int = 6
const PINEAPPLE_BONUS_SCORE: int = 100
const PINEAPPLE_BONUS_COINS: int = 20
```

**2. Add `_apply_golden_touch() -> int`:**
```gdscript
func _apply_golden_touch() -> int:
    ## Golden Touch: +2 coins per card per merge (flat, unconditional).
    var count: int = _count_active("golden_touch")
    if count <= 0:
        return 0
    return GOLDEN_TOUCH_COINS * count
```

**3. Add `_apply_lucky_break() -> int`:**
```gdscript
func _apply_lucky_break() -> int:
    ## Lucky Break: 15% independent chance per card for +5 bonus coins.
    ## Each card rolls independently -- 2 cards can both trigger for 10 coins.
    var count: int = _count_active("lucky_break")
    if count <= 0:
        return 0
    var total_coins: int = 0
    for i in count:
        if randf() < LUCKY_BREAK_CHANCE:
            total_coins += LUCKY_BREAK_COINS
    return total_coins
```

**4. Add `_apply_pineapple_express(new_tier: int) -> Dictionary`:**
```gdscript
func _apply_pineapple_express(new_tier: int) -> Dictionary:
    ## Pineapple Express: +100 score and +20 coins when Pear is created.
    ## Returns {"score": int, "coins": int}.
    var count: int = _count_active("pineapple_express")
    if count <= 0:
        return {"score": 0, "coins": 0}
    if new_tier != PINEAPPLE_TIER:
        return {"score": 0, "coins": 0}
    return {
        "score": PINEAPPLE_BONUS_SCORE * count,
        "coins": PINEAPPLE_BONUS_COINS * count,
    }
```

**5. Update `_apply_scoring_effects`** to include all six effects. Replace the Plan 01 partial dispatcher with the complete version:

```gdscript
func _apply_scoring_effects(_old_tier: int, new_tier: int, merge_pos: Vector2) -> void:
    ## Compute and apply all scoring/economy card bonuses for this merge.
    var bonus_score: int = 0
    var bonus_coins: int = 0

    # Score bonuses (Plan 01)
    bonus_score += _apply_quick_fuse(new_tier)
    bonus_score += _apply_fruit_frenzy(new_tier)
    bonus_score += _apply_big_game_hunter(new_tier)

    # Coin bonuses (Plan 02)
    bonus_coins += _apply_golden_touch()
    bonus_coins += _apply_lucky_break()

    # Mixed bonus (Plan 02)
    var pineapple: Dictionary = _apply_pineapple_express(new_tier)
    bonus_score += pineapple["score"]
    bonus_coins += pineapple["coins"]

    # Apply score bonus
    if bonus_score > 0:
        GameManager.score += bonus_score
        EventBus.bonus_awarded.emit(bonus_score, merge_pos, "score")

    # Apply coin bonus -- emit coins_awarded so HUD updates automatically
    if bonus_coins > 0:
        GameManager.coins += bonus_coins
        EventBus.coins_awarded.emit(bonus_coins, GameManager.coins)
        EventBus.bonus_awarded.emit(bonus_coins, merge_pos, "coins")
```

**Critical design notes:**
- Golden Touch is unconditional: every merge awards coins regardless of tier, chain, or any other condition. This makes it a reliable income card.
- Lucky Break uses independent rolls per card via `randf() < LUCKY_BREAK_CHANCE`. With 2 cards, the expected value is 1.5 coins/merge (each card has 0.15 * 5 = 0.75 expected coins).
- Pineapple Express maps "pineapple" to Pear (code tier 6) per research recommendation. It returns both score and coins as a Dictionary.
- Coin bonuses emit BOTH `coins_awarded` (so HUD coin counter updates via existing handler) AND `bonus_awarded` (so a green floating popup spawns). The dual emission ensures both the HUD counter and the world-space popup react.
- `coins_awarded` passes the updated `GameManager.coins` as total_coins parameter, matching ScoreManager's existing pattern.
- Direct coin additions do NOT update ScoreManager's `_coins_awarded` counter -- that counter only tracks score-threshold-derived coins to prevent double-awarding. Card coins are independent.
  </action>
  <verify>
Run `grep -n "_apply_golden_touch\|_apply_lucky_break\|_apply_pineapple_express\|GOLDEN_TOUCH\|LUCKY_BREAK\|PINEAPPLE" scripts/components/card_effect_system.gd`. Confirm:
1. All three effect methods exist with correct logic
2. All constants are defined (GOLDEN_TOUCH_COINS, LUCKY_BREAK_CHANCE, LUCKY_BREAK_COINS, PINEAPPLE_TIER, PINEAPPLE_BONUS_SCORE, PINEAPPLE_BONUS_COINS)
3. `_apply_scoring_effects` includes all 6 effect calls with both score and coin emission
  </verify>
  <done>
Golden Touch awards flat +2 coins per merge per card. Lucky Break rolls 15% independently per card for +5 coins. Pineapple Express awards +100 score and +20 coins on Pear creation. Complete dispatcher applies all 6 effects per merge with score bonus (purple popup via bonus_awarded) and coin bonus (green popup via bonus_awarded + counter update via coins_awarded). No ScoreManager modifications needed beyond Plan 01's accessor.
  </done>
</task>

</tasks>

<verification>
1. Golden Touch: Equip Golden Touch card. Merge any two fruits. Observe green "+2 coins" popup at merge position and HUD coin counter incrementing by 2.
2. Lucky Break: Equip Lucky Break card. Perform many merges. Observe occasional green "+5 coins" popup (approximately 15% of merges). With 2 Lucky Break cards, observe occasional "+10 coins" (both trigger).
3. Pineapple Express: Equip Pineapple Express card. Merge two Apples to create a Pear. Observe purple "+100" score popup AND green "+20 coins" popup. No bonus appears when creating any other tier.
4. Stacking: Equip multiple copies of Golden Touch. Verify coins per merge scale linearly (2 cards = +4 coins/merge).
5. Full pipeline: Equip all 6 Phase 7 cards across 3 slots (pick 3). Create a chain of 3+ merges creating a Pear. Verify Quick Fuse, Fruit Frenzy, Big Game Hunter, Golden Touch, and Pineapple Express all fire with visible popups. Lucky Break fires probabilistically.
</verification>

<success_criteria>
- All six Phase 7 card effects implemented and computing correct bonuses
- Golden Touch provides reliable per-merge coin income
- Lucky Break provides probabilistic coin bursts with independent per-card rolls
- Pineapple Express triggers specifically on Pear creation with both score and coin rewards
- Green coin bonus popups appear at merge positions via bonus_awarded signal
- HUD coin counter updates via coins_awarded signal for all direct coin awards
- No modifications to ScoreManager beyond Plan 01's get_chain_count() accessor
</success_criteria>

<output>
After completion, create `.planning/phases/07-card-effects-scoring-economy/07-02-SUMMARY.md`
</output>
