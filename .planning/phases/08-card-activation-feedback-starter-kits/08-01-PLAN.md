---
phase: 08-card-activation-feedback-starter-kits
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - scripts/autoloads/event_bus.gd
  - scripts/components/card_effect_system.gd
  - scenes/ui/card_slot_display.gd
  - scenes/ui/hud.gd
autonomous: true

must_haves:
  truths:
    - "When a card effect triggers during gameplay, the HUD card slot holding that card visually glows and bounces"
    - "Glow color matches card rarity: white for Common, green for Uncommon, purple for Rare"
    - "When multiple cards trigger on the same merge, their animations play staggered with ~0.15s delay"
    - "Charge-based cards (Heavy Hitter, Wild Fruit) get a more prominent animation than passive cards"
    - "Rapid re-triggers (e.g., Golden Touch every merge) are dampened -- slot stays glowing rather than strobing"
    - "All 10 existing card effects emit trigger feedback when their conditions are met"
  artifacts:
    - path: "scripts/autoloads/event_bus.gd"
      provides: "card_effect_triggered signal"
      contains: "signal card_effect_triggered"
    - path: "scripts/components/card_effect_system.gd"
      provides: "Signal emissions at all 10 card trigger points"
      contains: "card_effect_triggered.emit"
    - path: "scenes/ui/card_slot_display.gd"
      provides: "play_trigger_animation() method with rarity glow and scale bounce"
      contains: "func play_trigger_animation"
    - path: "scenes/ui/hud.gd"
      provides: "Staggered trigger queue dispatching animations to correct card slots"
      contains: "_trigger_queue"
  key_links:
    - from: "scripts/components/card_effect_system.gd"
      to: "scripts/autoloads/event_bus.gd"
      via: "EventBus.card_effect_triggered.emit(card_id)"
      pattern: "card_effect_triggered\\.emit"
    - from: "scenes/ui/hud.gd"
      to: "scripts/autoloads/event_bus.gd"
      via: "EventBus.card_effect_triggered.connect"
      pattern: "card_effect_triggered\\.connect"
    - from: "scenes/ui/hud.gd"
      to: "scenes/ui/card_slot_display.gd"
      via: "slot.play_trigger_animation(is_charge)"
      pattern: "play_trigger_animation"
---

<objective>
Add visual trigger feedback to all 10 card effects so players see which cards fire during gameplay.

Purpose: Players currently have no way to tell when their equipped cards activate. This creates a glow + scale bounce animation on HUD card slots at the moment of trigger, with rarity-colored glow, staggered multi-card animations, and charge vs passive differentiation.

Output: Modified event_bus.gd, card_effect_system.gd, card_slot_display.gd, and hud.gd with complete card trigger feedback system.
</objective>

<execution_context>
@/home/zycroft/.claude/get-shit-done/workflows/execute-plan.md
@/home/zycroft/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/08-card-activation-feedback-starter-kits/08-RESEARCH.md

Key files:
@scripts/autoloads/event_bus.gd
@scripts/components/card_effect_system.gd
@scenes/ui/card_slot_display.gd
@scenes/ui/hud.gd
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add trigger signal, CardSlotDisplay animation, and HUD staggered dispatch</name>
  <files>
    scripts/autoloads/event_bus.gd
    scenes/ui/card_slot_display.gd
    scenes/ui/hud.gd
  </files>
  <action>
**event_bus.gd** — Add one new signal after the existing `bonus_awarded` signal:
```gdscript
## Emitted when a card effect activates during gameplay (for HUD trigger animation).
signal card_effect_triggered(card_id: String)
```

**card_slot_display.gd** — Add trigger animation support:

1. Add a `_current_card: CardData` variable (initially null) to store the displayed card reference.
2. In `display_card()`, add `_current_card = card` at the top.
3. In `display_empty()`, add `_current_card = null` at the top.
4. Add a `_trigger_tween: Tween` variable to track the active trigger animation (for dampening).
5. Add rarity-to-glow-color mapping constant:
   ```
   TRIGGER_GLOW_COLORS = {
       COMMON: Color(1.0, 1.0, 1.0, 1.0),      # White
       UNCOMMON: Color(0.2, 0.9, 0.3, 1.0),     # Green
       RARE: Color(0.7, 0.4, 1.0, 1.0),         # Purple
   }
   ```
6. Add `func play_trigger_animation(is_charge: bool = false) -> void`:
   - Early return if `_current_card == null`.
   - **Dampening:** If `_trigger_tween` is valid and running, return early (skip re-trigger). This naturally dampens Golden Touch et al. — the 0.3-0.5s animation duration means the card stays glowing during rapid triggers.
   - Kill any existing `_trigger_tween` if valid (cleanup edge case).
   - Determine `glow_color` from `TRIGGER_GLOW_COLORS[_current_card.rarity]`, defaulting to `Color.WHITE`.
   - Differentiate charge vs passive:
     - **Passive:** `bounce_scale = 1.15`, `glow_duration = 0.3`, `border_width = 5`
     - **Charge:** `bounce_scale = 1.25`, `glow_duration = 0.5`, `border_width = 6`
   - Set `pivot_offset = size / 2.0` for centered scaling.
   - Create a duplicated StyleBoxFlat from theme panel (always `.duplicate()` to avoid shared resource mutation).
   - Set the style's `border_color` to `glow_color`, increase all four `border_width_*` to the target width.
   - Apply with `add_theme_stylebox_override("panel", style)`.
   - Create tween (`_trigger_tween = create_tween()`):
     - Phase 1 (parallel): Scale up to `Vector2(bounce_scale, bounce_scale)` in 0.1s with TRANS_BACK/EASE_OUT.
     - Phase 2: Scale back to `Vector2.ONE` in 0.2s.
     - Phase 3: Wait `glow_duration - 0.3` more seconds (so glow persists).
     - Phase 4: Call `_restore_normal_border()` callback.
7. Add `func _restore_normal_border() -> void`:
   - If `_current_card != null`, create fresh StyleBoxFlat duplicate, set `border_color` to `RARITY_COLORS[_current_card.rarity]`, restore default `border_width_*` to 3 (matching .tscn default). Apply override.
   - If `_current_card == null`, call `display_empty()` to reset.
8. Add `func get_card_id() -> String` returning `_current_card.card_id` if `_current_card != null`, else `""`.

**hud.gd** — Add trigger dispatch with staggered queue:

1. Add variables:
   ```gdscript
   var _trigger_queue: Array[String] = []
   const TRIGGER_STAGGER: float = 0.15
   ```
2. In `_ready()`, connect `EventBus.card_effect_triggered.connect(_on_card_effect_triggered)`.
3. Add charge card IDs constant for differentiating animation: `const CHARGE_CARD_IDS: Array[String] = ["heavy_hitter", "wild_fruit"]`
4. Add `func _on_card_effect_triggered(card_id: String) -> void`:
   - Append `card_id` to `_trigger_queue`.
   - If queue size is 1 (first entry just added), call `_play_next_trigger()`.
5. Add `func _play_next_trigger() -> void`:
   - If `_trigger_queue` is empty, return.
   - Pop front from `_trigger_queue`.
   - Determine `is_charge = card_id in CHARGE_CARD_IDS`.
   - Find ALL matching card slots: iterate `_card_slot_nodes`, check `slot.get_card_id() == card_id`. For each match, call `slot.play_trigger_animation(is_charge)`.
   - If `_trigger_queue` is not empty, `get_tree().create_timer(TRIGGER_STAGGER).timeout.connect(_play_next_trigger)`.
  </action>
  <verify>
Open in Godot editor, verify no script parse errors:
- Open event_bus.gd, card_slot_display.gd, hud.gd — confirm no red error markers.
- Run the game scene, pick a starter card, play until a merge occurs. If Golden Touch is equipped, observe the card slot glow on merge. If Cherry Bomb is equipped, observe trigger on cherry merges.
  </verify>
  <done>
EventBus has card_effect_triggered signal. CardSlotDisplay has play_trigger_animation() with rarity-colored glow + scale bounce + dampening. HUD dispatches triggers to correct card slots with 0.15s stagger queue. Charge cards get bigger bounce and longer glow than passive cards.
  </done>
</task>

<task type="auto">
  <name>Task 2: Emit trigger signals from all 10 card effects in CardEffectSystem</name>
  <files>scripts/components/card_effect_system.gd</files>
  <action>
Add `EventBus.card_effect_triggered.emit(card_id)` at each of the 10 card effect trigger points. The signal MUST only emit when the effect actually fires (condition met, count > 0, bonus > 0), not just when the check runs.

**In `_on_fruit_merged()`:**

1. **Cherry Bomb** (line ~127, after `_apply_cherry_bomb`): Already has the condition `cherry_count > 0 and old_tier == CHERRY_TIER`. Add `EventBus.card_effect_triggered.emit("cherry_bomb")` right after the `_apply_cherry_bomb()` call.

2. **Bouncy Berry** (line ~129-130): This is ambient/always-on. Per research recommendation, trigger feedback on `fruit_dropped` instead (more visible moment). In the merge handler, do NOT emit for bouncy_berry.

3. **Heavy Hitter recharge** (line ~134-138): Inside the `if _heavy_merge_counter >= HEAVY_RECHARGE_MERGES:` block, after resetting charges, add `EventBus.card_effect_triggered.emit("heavy_hitter")`.

4. **Wild Fruit selection** (line ~143-145): Inside `if _wild_merge_counter >= WILD_SELECT_INTERVAL:`, after `_select_wild_fruits()`, add `EventBus.card_effect_triggered.emit("wild_fruit")`.

**In `_on_fruit_dropped()`:**

5. **Bouncy Berry** (line ~152-153): After the `call_deferred("_apply_bouncy_berry_all")` line, add `EventBus.card_effect_triggered.emit("bouncy_berry")` — triggers per-drop (visible moment when bouncy effect applies).

6. **Heavy Hitter consume** (line ~155-166): Inside the `if _count_active("heavy_hitter") > 0 and _heavy_charges > 0:` block, after `_heavy_charges -= 1`, add `EventBus.card_effect_triggered.emit("heavy_hitter")`.

**In scoring effect helper functions** — emit only when bonus > 0:

7. **Quick Fuse** — In `_apply_quick_fuse()`, before the final `return` of the computed bonus (when it's > 0), add: `EventBus.card_effect_triggered.emit("quick_fuse")`. Specifically, change the return to compute the value first, check > 0, emit, then return.

8. **Fruit Frenzy** — Same pattern in `_apply_fruit_frenzy()`: compute bonus, if > 0, emit `"fruit_frenzy"`, then return.

9. **Big Game Hunter** — Same pattern in `_apply_big_game_hunter()`: compute bonus, if > 0, emit `"big_game_hunter"`, then return.

10. **Golden Touch** — In `_apply_golden_touch()`, before return, emit `"golden_touch"` when return value > 0.

11. **Lucky Break** — In `_apply_lucky_break()`, after the for loop, if `total_coins > 0`, emit `"lucky_break"` before return.

12. **Pineapple Express** — In `_apply_pineapple_express()`, when the result has score > 0 or coins > 0, emit `"pineapple_express"` before return.

**Implementation pattern for scoring functions** (use consistently):
```gdscript
func _apply_quick_fuse(new_tier: int) -> int:
    var count: int = _count_active("quick_fuse")
    if count == 0:
        return 0
    var sm: ScoreManager = get_tree().get_first_node_in_group("score_manager") as ScoreManager
    if sm == null or sm.get_chain_count() < 2:
        return 0
    var bonus: int = int(_get_base_score(new_tier) * QUICK_FUSE_BONUS * count)
    if bonus > 0:
        EventBus.card_effect_triggered.emit("quick_fuse")
    return bonus
```

Apply this pattern to all 6 scoring/economy helper functions.
  </action>
  <verify>
Open card_effect_system.gd in the Godot editor — no parse errors. Search for `card_effect_triggered.emit` and count exactly 12 emit calls (Cherry Bomb, Bouncy Berry on drop, Heavy Hitter recharge, Heavy Hitter consume, Wild Fruit, Quick Fuse, Fruit Frenzy, Big Game Hunter, Golden Touch, Lucky Break, Pineapple Express — Heavy Hitter has 2 triggers). Run the game, equip Golden Touch or a common card, merge fruits, observe trigger animation plays on the HUD card slot.
  </verify>
  <done>
All 10 card effects emit card_effect_triggered signals at their exact trigger points. Signals fire only when the effect actually activates (conditions met, bonus > 0). Heavy Hitter triggers on both charge consume and recharge. Bouncy Berry triggers on fruit drop (visible moment) not merge (too ambient).
  </done>
</task>

</tasks>

<verification>
1. Run game, pick a starter card (any card), play normally.
2. Observe: when the card's trigger condition is met, its HUD slot glows with rarity color and bounces.
3. Equip Golden Touch — every merge triggers glow without strobing (dampened by tween-is-running guard).
4. Equip Heavy Hitter — observe larger bounce/longer glow on charge consume and recharge vs normal cards.
5. Trigger two card effects simultaneously (e.g., Golden Touch + Cherry Bomb on cherry merge) — see staggered animations with ~0.15s delay.
6. Open card shop during active glow — glow freezes during pause, completes on resume (acceptable).
</verification>

<success_criteria>
- All 10 card effects produce visible HUD feedback when they trigger
- Glow colors: Common=white, Uncommon=green, Rare=purple
- Charge cards (Heavy Hitter, Wild Fruit) have visibly larger/longer animations
- No strobing on rapid triggers (Golden Touch tested)
- Multiple simultaneous triggers animate in staggered sequence
- No script parse errors, no runtime errors in Godot console
</success_criteria>

<output>
After completion, create `.planning/phases/08-card-activation-feedback-starter-kits/08-01-SUMMARY.md`
</output>
