---
phase: 08-card-activation-feedback-starter-kits
plan: 02
type: execute
wave: 1
depends_on: []
files_modified:
  - scripts/autoloads/card_manager.gd
  - scenes/ui/starter_pick.gd
  - scenes/ui/starter_pick.tscn
  - scripts/components/run_stats_tracker.gd
  - scenes/ui/run_summary.gd
  - scenes/ui/run_summary.tscn
  - scenes/game/game.tscn
  - scenes/game/game.gd
  - scenes/ui/hud.gd
  - scenes/ui/hud.tscn
autonomous: true

must_haves:
  truths:
    - "At run start, player sees 3 options: Physics Kit, Score Kit, and Surprise -- not individual card names"
    - "Kit name is visible but specific card is hidden until chosen"
    - "After choosing a kit, the card it contained appears in the HUD slot (player discovers what they got)"
    - "After game over, a run summary screen appears with 7 stats animating in one by one"
    - "Run summary shows: total merges, biggest chain, highest tier reached (with fruit visual), cards used, total coins earned, time played, final score"
    - "Play Again button restarts the run, Quit button reloads the page"
  artifacts:
    - path: "scripts/autoloads/card_manager.gd"
      provides: "STARTER_KITS data and generate_kit_offer() method"
      contains: "STARTER_KITS"
    - path: "scenes/ui/starter_pick.gd"
      provides: "Kit-based selection UI replacing individual card picks"
      contains: "Physics Kit"
    - path: "scripts/components/run_stats_tracker.gd"
      provides: "RunStatsTracker component tracking biggest_chain, highest_tier, total_merges, time_played, total_coins_earned, cards_used"
      contains: "class_name RunStatsTracker"
    - path: "scenes/ui/run_summary.gd"
      provides: "Run summary overlay with celebratory stat reveal animation"
      contains: "func _reveal_stats"
    - path: "scenes/ui/run_summary.tscn"
      provides: "Full-screen CanvasLayer overlay scene for run summary"
    - path: "scenes/game/game.tscn"
      provides: "RunStatsTracker node and RunSummary scene instances"
    - path: "scenes/game/game.gd"
      provides: "Game over -> delayed run summary show wiring"
      contains: "run_summary"
  key_links:
    - from: "scripts/components/run_stats_tracker.gd"
      to: "scripts/autoloads/event_bus.gd"
      via: "Connects to fruit_merged, chain_ended, coins_awarded, bonus_awarded, card_purchased, starter_pick_completed"
      pattern: "EventBus\\."
    - from: "scenes/game/game.gd"
      to: "scenes/ui/run_summary.gd"
      via: "Shows run summary after game over delay"
      pattern: "run_summary"
    - from: "scenes/ui/starter_pick.gd"
      to: "scripts/autoloads/card_manager.gd"
      via: "Calls CardManager.get_kit_card() to resolve chosen kit"
      pattern: "get_kit_card\\|STARTER_KITS"
---

<objective>
Replace the starter card pick with kit-based selection (Physics Kit, Score Kit, Surprise) and add a celebratory run summary screen with animated stat reveals at game over.

Purpose: Kit selection gives players strategic identity from the start (physics vs score focus), while the run summary makes every run feel like progress by celebrating what the player achieved with an animated stats reveal.

Output: Modified card_manager.gd, starter_pick.gd/tscn, game.gd/tscn, hud.gd/tscn. New run_stats_tracker.gd, run_summary.gd/tscn.
</objective>

<execution_context>
@/home/zycroft/.claude/get-shit-done/workflows/execute-plan.md
@/home/zycroft/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/08-card-activation-feedback-starter-kits/08-RESEARCH.md

Key files:
@scripts/autoloads/card_manager.gd
@scenes/ui/starter_pick.gd
@scenes/ui/starter_pick.tscn
@scenes/game/game.gd
@scenes/game/game.tscn
@scenes/ui/hud.gd
@scenes/ui/hud.tscn
@scripts/components/score_manager.gd
@scripts/autoloads/game_manager.gd
</context>

<tasks>

<task type="auto">
  <name>Task 1: Starter kit selection replacing individual card picks</name>
  <files>
    scripts/autoloads/card_manager.gd
    scenes/ui/starter_pick.gd
    scenes/ui/starter_pick.tscn
    scenes/game/game.gd
  </files>
  <action>
**card_manager.gd** — Add kit definitions and kit card generation:

1. Add kit data constant after PRICE_MULTIPLIERS:
```gdscript
## Starter kit definitions: 2 themed + 1 surprise.
const STARTER_KITS: Array[Dictionary] = [
    {
        "name": "Physics Kit",
        "description": "Modify how fruits move and collide",
        "card_pool": ["bouncy_berry", "cherry_bomb", "heavy_hitter", "wild_fruit"],
    },
    {
        "name": "Score Kit",
        "description": "Boost your score and chain bonuses",
        "card_pool": ["quick_fuse", "fruit_frenzy", "big_game_hunter", "pineapple_express"],
    },
    {
        "name": "Surprise!",
        "description": "A random card from any category",
        "card_pool": [],  # Empty = pick from full pool
    },
]
```

2. Add `func get_kit_card(kit_index: int) -> CardData`:
   - Get the kit from `STARTER_KITS[kit_index]`.
   - If `card_pool` is empty (Surprise), return `_card_pool.pick_random()`.
   - Otherwise, filter `_card_pool` to only cards whose `card_id` is in the kit's `card_pool` array. Return `.pick_random()` from that filtered list.
   - Fallback: if filtered list is empty, return `_card_pool.pick_random()`.

**starter_pick.tscn** — Update text labels:

1. Change TitleLabel text from "Choose a Starting Card" to "Choose a Starter Kit".
2. Change SubtitleLabel text from "Pick 1 card to begin your run" to "Each kit contains a mystery card".

**starter_pick.gd** — Replace card-based display with kit-based:

1. Replace `_on_starter_pick_requested(offers: Array)` entirely. The new version ignores the `offers` parameter (kept for signal compatibility) and builds kit rows instead:
   - Clear OffersContainer children (existing pattern).
   - Iterate `CardManager.STARTER_KITS` by index. For each kit:
     - Create HBoxContainer row (same pattern as current).
     - Instead of a CardSlotDisplay showing card details, create a **PanelContainer** manually (or simpler: create a VBoxContainer with kit name Label and kit description Label, styled to look like a card slot but without card specifics).
     - **Simpler approach:** Create a VBoxContainer inside the row with:
       - A Label for kit name (font_size 22, bold feel, centered).
       - A Label for kit description (font_size 14, centered, autowrap).
       - Style the VBoxContainer's parent PanelContainer with a StyleBoxFlat matching card_slot_display look (dark bg, rounded corners, border).
     - Create a "Pick" Button (same as current pattern).
     - Bind button pressed to `_on_kit_picked.bind(kit_index)` instead of `_on_card_picked.bind(card)`.
   - Set visible = true.

2. Replace `_on_card_picked(card)` with `func _on_kit_picked(kit_index: int) -> void`:
   - Call `var card: CardData = CardManager.get_kit_card(kit_index)`.
   - Call `CardManager.add_card(card, 0)` (free card, same as before).
   - Emit `EventBus.starter_pick_completed.emit(card)`.
   - Emit `EventBus.active_cards_changed.emit(CardManager.active_cards)`.
   - Clean up OffersContainer children.
   - Set visible = false.

**game.gd** — Minimal change to `_show_starter_pick()`:
- The `generate_starter_offers(3)` call is still made for signal compatibility (starter_pick_requested expects an Array parameter). The StarterPick UI now ignores this array and shows kits instead. Alternatively, simplify by passing an empty array: `EventBus.starter_pick_requested.emit([])`. Either works since starter_pick.gd ignores the parameter now.
- Change the line to: `EventBus.starter_pick_requested.emit([])` and remove the `CardManager.generate_starter_offers(3)` call since it's no longer needed.
  </action>
  <verify>
Run the game. On startup, the starter pick overlay should show 3 rows: "Physics Kit", "Score Kit", "Surprise!" with descriptions -- NOT individual card names. Pick one. A card should appear in the HUD slot. Game should transition to DROPPING state normally.
  </verify>
  <done>
Starter pick shows 3 kit options (Physics Kit, Score Kit, Surprise) with names and descriptions. Card inside is hidden until picked. After picking, the resolved card appears in HUD. Existing game flow (PICKING -> DROPPING state transition) unchanged.
  </done>
</task>

<task type="auto">
  <name>Task 2: Run stats tracker and celebratory run summary screen</name>
  <files>
    scripts/components/run_stats_tracker.gd
    scenes/ui/run_summary.gd
    scenes/ui/run_summary.tscn
    scenes/game/game.tscn
    scenes/game/game.gd
    scenes/ui/hud.gd
    scenes/ui/hud.tscn
  </files>
  <action>
**scripts/components/run_stats_tracker.gd** — New file, follows component pattern:

```gdscript
class_name RunStatsTracker
extends Node
## Tracks per-run statistics for the run summary screen.
## Lives in the game scene tree (not autoload) for automatic cleanup on reset.
```

1. Add to group `"run_stats_tracker"` in `_ready()`.
2. Track these stats as instance variables:
   - `var biggest_chain: int = 0`
   - `var highest_tier: int = 0` (code tier, 0-indexed)
   - `var total_merges: int = 0`
   - `var total_coins_earned: int = 0`
   - `var cards_used: Array[String] = []` (unique card_ids ever held)
   - `var _start_time_msec: int = 0` (set in `_ready()` via `Time.get_ticks_msec()`)
3. Connect signals in `_ready()`:
   - `EventBus.fruit_merged.connect(_on_fruit_merged)` — increment `total_merges`, update `highest_tier = maxi(highest_tier, new_tier)`.
   - `EventBus.chain_ended.connect(_on_chain_ended)` — update `biggest_chain = maxi(biggest_chain, chain_length)`.
   - `EventBus.coins_awarded.connect(_on_coins_awarded)` — add `new_coins` to `total_coins_earned`.
   - `EventBus.bonus_awarded.connect(_on_bonus_awarded)` — if `bonus_type == "coins"`, add `amount` to `total_coins_earned`.
   - `EventBus.card_purchased.connect(_on_card_purchased)` — add `card.card_id` to `cards_used` if not already present.
   - `EventBus.starter_pick_completed.connect(_on_starter_pick)` — add `card.card_id` to `cards_used` if not already present.
4. Add `func get_time_played_seconds() -> int`:
   - Return `(Time.get_ticks_msec() - _start_time_msec) / 1000`.
5. Add `func get_stats() -> Dictionary`:
   - Return `{ "biggest_chain": biggest_chain, "highest_tier": highest_tier, "total_merges": total_merges, "total_coins_earned": total_coins_earned, "cards_used": cards_used, "time_played": get_time_played_seconds(), "final_score": GameManager.score }`.

**scenes/ui/run_summary.tscn** — New CanvasLayer overlay scene:

Create the scene following the established overlay pattern (matches CardShop/StarterPick/PauseMenu):
- Root: CanvasLayer named "RunSummary", layer = 12 (above CardShop/StarterPick at 11), process_mode = PROCESS_MODE_ALWAYS, visible = false.
- Child: ColorRect "Overlay" — full screen (anchors_preset=15, anchor_right=1.0, anchor_bottom=1.0), color = Color(0, 0, 0, 0.85), mouse_filter = STOP.
- Child of Overlay: VBoxContainer "SummaryContainer" — centered (anchors_preset=8), offset ~(-400, -450, 400, 450), mouse_filter = IGNORE, separation = 16.
- Inside SummaryContainer:
  - Label "TitleLabel": text = "Run Complete!", font_size = 48, centered, outline 6px black.
  - HSeparator (or empty spacer Control, height 10).
  - 7 Label nodes for stats, all initially invisible (modulate.a = 0), font_size 24-28, centered:
    - "MergesLabel"
    - "ChainLabel"
    - "TierLabel"
    - "CardsLabel"
    - "CoinsLabel"
    - "TimeLabel"
    - "ScoreLabel" (font_size 40 — the big reveal)
  - HBoxContainer "ButtonRow" (centered, separation=20, initially invisible):
    - Button "PlayAgainButton": text = "Play Again", min size 200x60, font_size 24.
    - Button "QuitButton": text = "Quit", min size 200x60, font_size 24.

Attach script `run_summary.gd`.

**scenes/ui/run_summary.gd** — New script:

1. Variables:
   - `var _fruit_types: Array[FruitData] = []` (loaded in `_ready()` same pattern as HUD).
   - Stat label references obtained via `$Overlay/SummaryContainer/...` paths.
2. `_ready()`:
   - `process_mode = Node.PROCESS_MODE_ALWAYS`
   - `visible = false`
   - Load fruit types.
   - Connect `$Overlay/SummaryContainer/ButtonRow/PlayAgainButton.pressed.connect(_on_play_again)`.
   - Connect `$Overlay/SummaryContainer/ButtonRow/QuitButton.pressed.connect(_on_quit)`.
3. Add `func show_summary(stats: Dictionary) -> void`:
   - Populate label text from stats dictionary:
     - MergesLabel: "Total Merges: %d" % stats.total_merges
     - ChainLabel: "Biggest Chain: %d" % stats.biggest_chain
     - TierLabel: "Highest Tier: %s" % _get_tier_name(stats.highest_tier) — include the fruit name (e.g., "Pear"). If highest_tier is valid index in _fruit_types, use the fruit name.
     - CardsLabel: "Cards Used: %d" % stats.cards_used.size() — followed by card names if space allows, or just the count.
     - CoinsLabel: "Total Coins Earned: %d" % stats.total_coins_earned
     - TimeLabel: "Time Played: %s" % _format_time(stats.time_played)
     - ScoreLabel: "Final Score: %d" % stats.final_score
   - Set all stat labels to `modulate.a = 0.0` and `scale = Vector2(0.5, 0.5)` with `pivot_offset = size / 2.0`.
   - Hide ButtonRow initially.
   - Set `visible = true`.
   - Pause the tree: `get_tree().paused = true`.
   - Call `_reveal_stats()`.
4. `func _reveal_stats() -> void`:
   - Create a single sequential tween.
   - For each stat label in reveal order (MergesLabel, ChainLabel, TierLabel, CardsLabel, CoinsLabel, TimeLabel, then ScoreLabel):
     - Tween modulate.a from 0 to 1.0 in 0.3s.
     - Parallel: tween scale from 0.5 to 1.0 in 0.3s with TRANS_BACK/EASE_OUT.
     - Add 0.15s interval between stats (tween_interval).
   - After ScoreLabel, add extra 0.2s delay.
   - ScoreLabel gets a bigger scale punch: from 0.3 to 1.0 in 0.4s.
   - Final callback: show ButtonRow (set visible, fade in).
5. `func _format_time(seconds: int) -> String`:
   - Format as "Xm Ys" (e.g., "2m 34s"). If >= 3600, show hours.
6. `func _get_tier_name(tier: int) -> String`:
   - If tier >= 0 and tier < _fruit_types.size(), return the fruit data's display name. The FruitData doesn't store a name, so use a hardcoded tier name array: `["Blueberry", "Grape", "Cherry", "Strawberry", "Orange", "Apple", "Pear", "Watermelon"]`.
   - If tier >= _fruit_types.size(), return "Watermelon" (watermelon vanish case, tier=8).
7. `func _on_play_again() -> void`:
   - `get_tree().paused = false`
   - `GameManager.reset_game()`
   - `get_tree().reload_current_scene()`
8. `func _on_quit() -> void`:
   - Try `JavaScriptBridge.eval("window.location.reload()")` for web.
   - Fallback: `get_tree().quit()` for native.

**scenes/game/game.tscn** — Add two new nodes:

1. Add a Node child "RunStatsTracker" with script `res://scripts/components/run_stats_tracker.gd` and group `"run_stats_tracker"`. Place after CardEffectSystem in tree order.
2. Add the `run_summary.tscn` PackedScene instance as "RunSummary" child. Place after StarterPick.

**scenes/game/game.gd** — Wire game over to run summary:

1. Replace `_on_game_over()` with:
```gdscript
func _on_game_over() -> void:
    GameManager.change_state(GameManager.GameState.GAME_OVER)
    # Delay showing summary so fruits settle visually (GAME_OVER doesn't pause tree).
    await get_tree().create_timer(2.5).timeout
    _show_run_summary()

func _show_run_summary() -> void:
    var tracker: RunStatsTracker = get_tree().get_first_node_in_group("run_stats_tracker") as RunStatsTracker
    if tracker:
        var stats: Dictionary = tracker.get_stats()
        $RunSummary.show_summary(stats)
```

**scenes/ui/hud.gd and hud.tscn** — Hide GameOverLabel (replaced by run summary):

In `hud.gd` `_on_game_state_changed()`, keep the GAME_OVER branch but **remove** `$GameOverLabel.visible = true`. The run summary screen now serves as the game over indicator. Optionally: remove the GameOverLabel node from hud.tscn entirely, or just never show it.

Simplest: Change the GAME_OVER branch to only hide the pause button:
```gdscript
if new_state == GameManager.GameState.GAME_OVER:
    $PauseButton.visible = false
```
Remove the `$GameOverLabel.visible = true` line. The GameOverLabel node can stay in .tscn but is never shown.
  </action>
  <verify>
1. Run the game, pick a kit, play until game over (let a fruit sit above overflow line for 2s).
2. After ~2.5s delay, the run summary overlay should appear with "Run Complete!" title.
3. Stats should animate in one by one: Total Merges, Biggest Chain, Highest Tier (with fruit name), Cards Used, Total Coins Earned, Time Played, Final Score (biggest).
4. "Play Again" button restarts the game cleanly (new starter kit selection appears).
5. "Quit" button reloads the page (web) or quits (native).
6. Verify total_coins_earned counts both ScoreManager coins and card bonus coins.
  </verify>
  <done>
Starter kit selection replaces individual card picks (Physics Kit, Score Kit, Surprise). RunStatsTracker accumulates biggest_chain, highest_tier, total_merges, total_coins_earned, cards_used, time_played throughout the run. Run summary screen shows 7 animated stats after game over with 2.5s delay for fruit settling. Play Again and Quit buttons work. GameOverLabel no longer shown (replaced by run summary).
  </done>
</task>

</tasks>

<verification>
1. **Starter Kits:** Run game -> see "Choose a Starter Kit" with Physics Kit, Score Kit, Surprise. Pick one -> mystery card appears in HUD slot. Game starts normally.
2. **Run Stats:** Play a full run with merges, chains, card effects. All stats should accumulate correctly.
3. **Run Summary:** Trigger game over -> after 2.5s delay, summary screen appears -> stats reveal one by one with animation -> Final Score is the big reveal.
4. **Play Again:** Click "Play Again" on summary -> clean restart, new kit selection, score/coins/stats all reset.
5. **Quit:** Click "Quit" -> page reloads (web) or app quits (native).
6. **Full cycle:** Play Again -> pick kit -> play -> game over -> summary -> Play Again (verify no leaks or state corruption across multiple runs).
</verification>

<success_criteria>
- Starter pick shows 3 kit options with names and descriptions, card inside hidden
- After picking, correct card from kit's pool appears in HUD
- Run summary appears ~2.5s after game over with all 7 stats
- Stats animate in celebratory sequence, Final Score last and largest
- Play Again cleanly restarts, Quit reloads/quits
- No runtime errors across multiple play-restart cycles
- Total coins stat captures both ScoreManager coins and card bonus coins
</success_criteria>

<output>
After completion, create `.planning/phases/08-card-activation-feedback-starter-kits/08-02-SUMMARY.md`
</output>
